# ESTRUCTURA COMPLETA BASE DE DATOS - SISTEMA DENTAL
**Fecha:** 2025-11-04 12:20:44

---

## TABLA: `usuarios`

```
                                                             Table "public.usuarios"
       Column        |           Type           | Collation | Nullable |      Default       | Storage  | Compression | Stats target | Description 
---------------------+--------------------------+-----------+----------+--------------------+----------+-------------+--------------+-------------
 id                  | uuid                     |           | not null | uuid_generate_v4() | plain    |             |              | 
 email               | character varying(100)   |           | not null |                    | extended |             |              | 
 rol_id              | uuid                     |           | not null |                    | plain    |             |              | 
 activo              | boolean                  |           |          | true               | plain    |             |              | 
 fecha_creacion      | timestamp with time zone |           |          | CURRENT_TIMESTAMP  | plain    |             |              | 
 fecha_actualizacion | timestamp with time zone |           |          | CURRENT_TIMESTAMP  | plain    |             |              | 
 ultimo_acceso       | timestamp with time zone |           |          |                    | plain    |             |              | 
 configuraciones     | jsonb                    |           |          | '{}'::jsonb        | extended |             |              | 
 auth_user_id        | uuid                     |           |          |                    | plain    |             |              | 
 avatar_url          | text                     |           |          |                    | extended |             |              | 
 metadata            | jsonb                    |           |          | '{}'::jsonb        | extended |             |              | 
Indexes:
    "usuarios_pkey" PRIMARY KEY, btree (id)
    "idx_usuarios_activo" btree (activo)
    "idx_usuarios_auth_user_id" btree (auth_user_id)
    "idx_usuarios_email" btree (email)
    "usuarios_auth_user_id_key" UNIQUE CONSTRAINT, btree (auth_user_id)
    "usuarios_email_key" UNIQUE CONSTRAINT, btree (email)
Check constraints:
    "chk_usuarios_email_valido" CHECK (email::text ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text)
Foreign-key constraints:
    "usuarios_rol_id_fkey" FOREIGN KEY (rol_id) REFERENCES roles(id)
Referenced by:
    TABLE "condiciones_diente" CONSTRAINT "condiciones_diente_registrado_por_fkey" FOREIGN KEY (registrado_por) REFERENCES usuarios(id)
    TABLE "consultas" CONSTRAINT "consultas_creada_por_fkey" FOREIGN KEY (creada_por) REFERENCES usuarios(id)
    TABLE "imagenes_clinicas" CONSTRAINT "imagenes_clinicas_capturada_por_fkey" FOREIGN KEY (capturada_por) REFERENCES usuarios(id)
    TABLE "pacientes" CONSTRAINT "pacientes_registrado_por_fkey" FOREIGN KEY (registrado_por) REFERENCES usuarios(id)
    TABLE "pagos" CONSTRAINT "pagos_autorizado_por_fkey" FOREIGN KEY (autorizado_por) REFERENCES usuarios(id)
    TABLE "pagos" CONSTRAINT "pagos_procesado_por_fkey" FOREIGN KEY (procesado_por) REFERENCES usuarios(id)
    TABLE "personal" CONSTRAINT "personal_usuario_id_fkey" FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
    TABLE "servicios" CONSTRAINT "servicios_creado_por_fkey" FOREIGN KEY (creado_por) REFERENCES usuarios(id)
Policies:
    POLICY "usuarios_policy"
      USING (true)
Triggers:
    trigger_usuarios_fecha_actualizacion BEFORE UPDATE ON usuarios FOR EACH ROW EXECUTE FUNCTION actualizar_fecha_modificacion()
Access method: heap

```

---

## TABLA: `roles`

```
                                                               Table "public.roles"
       Column        |           Type           | Collation | Nullable |      Default       | Storage  | Compression | Stats target | Description 
---------------------+--------------------------+-----------+----------+--------------------+----------+-------------+--------------+-------------
 id                  | uuid                     |           | not null | uuid_generate_v4() | plain    |             |              | 
 nombre              | character varying(50)    |           | not null |                    | extended |             |              | 
 descripcion         | text                     |           |          |                    | extended |             |              | 
 permisos            | jsonb                    |           |          | '{}'::jsonb        | extended |             |              | 
 activo              | boolean                  |           |          | true               | plain    |             |              | 
 fecha_creacion      | timestamp with time zone |           |          | CURRENT_TIMESTAMP  | plain    |             |              | 
 fecha_actualizacion | timestamp with time zone |           |          | CURRENT_TIMESTAMP  | plain    |             |              | 
Indexes:
    "roles_pkey" PRIMARY KEY, btree (id)
    "roles_nombre_key" UNIQUE CONSTRAINT, btree (nombre)
Check constraints:
    "chk_roles_nombre_valido" CHECK (nombre::text ~ '^[a-z_]+$'::text)
    "chk_roles_permisos_json" CHECK (jsonb_typeof(permisos) = 'object'::text)
Referenced by:
    TABLE "usuarios" CONSTRAINT "usuarios_rol_id_fkey" FOREIGN KEY (rol_id) REFERENCES roles(id)
Access method: heap

```

---

## TABLA: `personal`

```
                                                                    Table "public.personal"
         Column          |           Type           | Collation | Nullable |           Default           | Storage  | Compression | Stats target | Description 
-------------------------+--------------------------+-----------+----------+-----------------------------+----------+-------------+--------------+-------------
 id                      | uuid                     |           | not null | uuid_generate_v4()          | plain    |             |              | 
 usuario_id              | uuid                     |           |          |                             | plain    |             |              | 
 primer_nombre           | character varying(50)    |           | not null |                             | extended |             |              | 
 segundo_nombre          | character varying(50)    |           |          |                             | extended |             |              | 
 primer_apellido         | character varying(50)    |           | not null |                             | extended |             |              | 
 segundo_apellido        | character varying(50)    |           |          |                             | extended |             |              | 
 tipo_documento          | character varying(20)    |           |          | 'CI'::character varying     | extended |             |              | 
 numero_documento        | character varying(20)    |           | not null |                             | extended |             |              | 
 fecha_nacimiento        | date                     |           |          |                             | plain    |             |              | 
 direccion               | character varying(200)   |           |          |                             | extended |             |              | 
 celular                 | character varying(20)    |           | not null |                             | extended |             |              | 
 tipo_personal           | character varying(20)    |           | not null |                             | extended |             |              | 
 especialidad            | character varying(100)   |           |          |                             | extended |             |              | 
 numero_licencia         | character varying(50)    |           |          |                             | extended |             |              | 
 fecha_contratacion      | date                     |           | not null | CURRENT_DATE                | plain    |             |              | 
 salario                 | numeric(10,2)            |           |          |                             | main     |             |              | 
 estado_laboral          | character varying(20)    |           |          | 'activo'::character varying | extended |             |              | 
 observaciones           | text                     |           |          |                             | extended |             |              | 
 acepta_pacientes_nuevos | boolean                  |           |          | true                        | plain    |             |              | 
 orden_preferencia       | integer                  |           |          | 1                           | plain    |             |              | 
 fecha_creacion          | timestamp with time zone |           |          | CURRENT_TIMESTAMP           | plain    |             |              | 
 fecha_actualizacion     | timestamp with time zone |           |          | CURRENT_TIMESTAMP           | plain    |             |              | 
Indexes:
    "personal_pkey" PRIMARY KEY, btree (id)
    "idx_personal_documento" btree (numero_documento)
    "idx_personal_odontologos_disponibles" btree (tipo_personal, acepta_pacientes_nuevos, estado_laboral)
    "idx_personal_tipo_estado" btree (tipo_personal, estado_laboral)
    "idx_personal_usuario_id" btree (usuario_id)
    "personal_numero_documento_key" UNIQUE CONSTRAINT, btree (numero_documento)
    "personal_usuario_id_key" UNIQUE CONSTRAINT, btree (usuario_id)
Check constraints:
    "chk_personal_celular" CHECK (celular::text ~ '^[\+]?[\d\s\-\(\)]{7,20}$'::text)
    "chk_personal_documento" CHECK (numero_documento::text ~ '^\d{6,20}$'::text)
    "chk_personal_salario" CHECK (salario IS NULL OR salario >= 0::numeric)
    "personal_estado_laboral_check" CHECK (estado_laboral::text = ANY (ARRAY['activo'::character varying, 'inactivo'::character varying]::text[]))
    "personal_tipo_documento_check" CHECK (tipo_documento::text = ANY (ARRAY['CI'::character varying, 'Pasaporte'::character varying]::text[]))
    "personal_tipo_personal_check" CHECK (tipo_personal::text = ANY (ARRAY['Odontólogo'::character varying, 'Asistente'::character varying, 'Administrador'::character varying, 'Gerente'::character varying]::text[]))
Foreign-key constraints:
    "personal_usuario_id_fkey" FOREIGN KEY (usuario_id) REFERENCES usuarios(id) ON DELETE CASCADE
Referenced by:
    TABLE "consultas" CONSTRAINT "consultas_primer_odontologo_id_fkey" FOREIGN KEY (primer_odontologo_id) REFERENCES personal(id)
    TABLE "historial_medico" CONSTRAINT "historial_medico_odontologo_id_fkey" FOREIGN KEY (odontologo_id) REFERENCES personal(id)
    TABLE "intervenciones" CONSTRAINT "intervenciones_asistente_id_fkey" FOREIGN KEY (asistente_id) REFERENCES personal(id)
    TABLE "intervenciones" CONSTRAINT "intervenciones_odontologo_id_fkey" FOREIGN KEY (odontologo_id) REFERENCES personal(id)
Policies:
    POLICY "personal_policy"
      USING (true)
Triggers:
    trigger_personal_fecha_actualizacion BEFORE UPDATE ON personal FOR EACH ROW EXECUTE FUNCTION actualizar_fecha_modificacion()
Access method: heap

```

---

## TABLA: `servicios`

```
                                                                                                                                       Table "public.servicios"
        Column        |           Type           | Collation | Nullable |                  Default                   | Storage  | Compression | Stats target |                                                               Description                                                               
----------------------+--------------------------+-----------+----------+--------------------------------------------+----------+-------------+--------------+-----------------------------------------------------------------------------------------------------------------------------------------
 id                   | uuid                     |           | not null | uuid_generate_v4()                         | plain    |             |              | 
 codigo               | character varying(20)    |           | not null |                                            | extended |             |              | 
 nombre               | character varying(100)   |           | not null |                                            | extended |             |              | 
 descripcion          | text                     |           |          |                                            | extended |             |              | 
 categoria            | character varying(50)    |           | not null |                                            | extended |             |              | 
 precio_base_usd      | numeric(10,2)            |           | not null |                                            | main     |             |              | 
 material_incluido    | text[]                   |           |          |                                            | extended |             |              | 
 activo               | boolean                  |           |          | true                                       | plain    |             |              | 
 fecha_creacion       | timestamp with time zone |           |          | CURRENT_TIMESTAMP                          | plain    |             |              | 
 creado_por           | uuid                     |           |          |                                            | plain    |             |              | 
 alcance_servicio     | character varying(25)    |           | not null | 'superficie_especifica'::character varying | extended |             |              |                                                                                                                                        +
                      |                          |           |          |                                            |          |             |              | Alcance de aplicación del servicio:                                                                                                    +
                      |                          |           |          |                                            |          |             |              | - superficie_especifica: Se aplica a superficies individuales (oclusal, mesial, etc.)                                                  +
                      |                          |           |          |                                            |          |             |              | - diente_completo: Se aplica al diente completo (extracción, corona, implante)                                                         +
                      |                          |           |          |                                            |          |             |              | - boca_completa: Se aplica a toda la boca (blanqueamiento, limpieza, profilaxis)                                                       +
                      |                          |           |          |                                            |          |             |              | 
 condicion_resultante | character varying(50)    |           |          |                                            | extended |             |              | Condición que resulta en el odontograma después de aplicar este servicio. NULL = no modifica odontograma (ej: limpieza, blanqueamiento)
Indexes:
    "servicios_pkey" PRIMARY KEY, btree (id)
    "idx_servicios_alcance" btree (alcance_servicio)
    "idx_servicios_condicion_resultante" btree (condicion_resultante) WHERE condicion_resultante IS NOT NULL
    "servicios_codigo_key" UNIQUE CONSTRAINT, btree (codigo)
Check constraints:
    "check_condicion_resultante_valida" CHECK (condicion_resultante IS NULL OR (condicion_resultante::text = ANY (ARRAY['sano'::character varying, 'caries'::character varying, 'obturacion'::character varying, 'corona'::character varying, 'puente'::character varying, 'implante'::character varying, 'ausente'::character varying, 'extraccion_indicada'::character varying, 'endodoncia'::character varying, 'protesis'::character varying, 'fractura'::character varying, 'mancha'::character varying, 'desgaste'::character varying, 'sensibilidad'::character varying, 'movilidad'::character varying, 'impactado'::character varying, 'en_erupcion'::character varying, 'retenido'::character varying, 'supernumerario'::character varying, 'otro'::character varying]::text[])))
    "chk_alcance_servicio" CHECK (alcance_servicio::text = ANY (ARRAY['superficie_especifica'::character varying, 'diente_completo'::character varying, 'boca_completa'::character varying]::text[]))
    "chk_servicios_codigo" CHECK (codigo::text ~ '^[A-Z0-9]+$'::text)
    "chk_servicios_precio_usd" CHECK (precio_base_usd > 0::numeric)
Foreign-key constraints:
    "servicios_creado_por_fkey" FOREIGN KEY (creado_por) REFERENCES usuarios(id)
Referenced by:
    TABLE "intervenciones_servicios" CONSTRAINT "intervenciones_servicios_servicio_id_fkey" FOREIGN KEY (servicio_id) REFERENCES servicios(id)
Access method: heap

```

---

## TABLA: `pacientes`

```
                                                                 Table "public.pacientes"
         Column          |           Type           | Collation | Nullable |         Default         | Storage  | Compression | Stats target | Description 
-------------------------+--------------------------+-----------+----------+-------------------------+----------+-------------+--------------+-------------
 id                      | uuid                     |           | not null | uuid_generate_v4()      | plain    |             |              | 
 numero_historia         | character varying(20)    |           | not null |                         | extended |             |              | 
 primer_nombre           | character varying(50)    |           | not null |                         | extended |             |              | 
 segundo_nombre          | character varying(50)    |           |          |                         | extended |             |              | 
 primer_apellido         | character varying(50)    |           | not null |                         | extended |             |              | 
 segundo_apellido        | character varying(50)    |           |          |                         | extended |             |              | 
 tipo_documento          | character varying(20)    |           |          | 'CI'::character varying | extended |             |              | 
 numero_documento        | character varying(20)    |           | not null |                         | extended |             |              | 
 fecha_nacimiento        | date                     |           |          |                         | plain    |             |              | 
 edad                    | integer                  |           |          |                         | plain    |             |              | 
 genero                  | character varying(10)    |           |          |                         | extended |             |              | 
 celular_1               | character varying(20)    |           |          |                         | extended |             |              | 
 celular_2               | character varying(20)    |           |          |                         | extended |             |              | 
 email                   | character varying(100)   |           |          |                         | extended |             |              | 
 direccion               | text                     |           |          |                         | extended |             |              | 
 ciudad                  | character varying(100)   |           |          |                         | extended |             |              | 
 departamento            | character varying(100)   |           |          |                         | extended |             |              | 
 ocupacion               | character varying(100)   |           |          |                         | extended |             |              | 
 estado_civil            | character varying(20)    |           |          |                         | extended |             |              | 
 contacto_emergencia     | jsonb                    |           |          | '{}'::jsonb             | extended |             |              | 
 alergias                | text[]                   |           |          |                         | extended |             |              | 
 medicamentos_actuales   | text[]                   |           |          |                         | extended |             |              | 
 condiciones_medicas     | text[]                   |           |          |                         | extended |             |              | 
 antecedentes_familiares | text[]                   |           |          |                         | extended |             |              | 
 fecha_registro          | timestamp with time zone |           |          | CURRENT_TIMESTAMP       | plain    |             |              | 
 fecha_actualizacion     | timestamp with time zone |           |          | CURRENT_TIMESTAMP       | plain    |             |              | 
 registrado_por          | uuid                     |           |          |                         | plain    |             |              | 
 activo                  | boolean                  |           |          | true                    | plain    |             |              | 
 observaciones           | text                     |           |          |                         | extended |             |              | 
Indexes:
    "pacientes_pkey" PRIMARY KEY, btree (id)
    "idx_pacientes_activo" btree (activo)
    "idx_pacientes_celular1" btree (celular_1)
    "idx_pacientes_fecha_registro" btree (fecha_registro)
    "idx_pacientes_nombres_completo" btree (primer_nombre, primer_apellido)
    "idx_pacientes_numero_documento" btree (numero_documento)
    "pacientes_numero_documento_key" UNIQUE CONSTRAINT, btree (numero_documento)
    "pacientes_numero_historia_key" UNIQUE CONSTRAINT, btree (numero_historia)
Check constraints:
    "chk_pacientes_celular1" CHECK (celular_1 IS NULL OR celular_1::text ~ '^[\+]?[\d\s\-\(\)]{7,20}$'::text)
    "chk_pacientes_celular2" CHECK (celular_2 IS NULL OR celular_2::text ~ '^[\+]?[\d\s\-\(\)]{7,20}$'::text)
    "chk_pacientes_documento" CHECK (numero_documento::text ~ '^\d{6,20}$'::text)
    "chk_pacientes_edad" CHECK (edad IS NULL OR edad >= 0 AND edad <= 150)
    "chk_pacientes_email" CHECK (email IS NULL OR email::text ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'::text)
    "pacientes_genero_check" CHECK (genero::text = ANY (ARRAY['masculino'::character varying, 'femenino'::character varying, 'otro'::character varying]::text[]))
    "pacientes_tipo_documento_check" CHECK (tipo_documento::text = ANY (ARRAY['CI'::character varying, 'Pasaporte'::character varying]::text[]))
Foreign-key constraints:
    "pacientes_registrado_por_fkey" FOREIGN KEY (registrado_por) REFERENCES usuarios(id)
Referenced by:
    TABLE "condiciones_diente" CONSTRAINT "condiciones_diente_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id) ON DELETE CASCADE
    TABLE "consultas" CONSTRAINT "consultas_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
    TABLE "historial_medico" CONSTRAINT "historial_medico_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
    TABLE "imagenes_clinicas" CONSTRAINT "imagenes_clinicas_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
    TABLE "pagos" CONSTRAINT "pagos_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
Policies:
    POLICY "pacientes_policy"
      USING (true)
Triggers:
    trigger_calcular_edad_paciente BEFORE INSERT OR UPDATE ON pacientes FOR EACH ROW EXECUTE FUNCTION calcular_edad_paciente()
    trigger_crear_odontograma_inicial AFTER INSERT ON pacientes FOR EACH ROW EXECUTE FUNCTION crear_odontograma_inicial()
    trigger_generar_numero_historia BEFORE INSERT ON pacientes FOR EACH ROW EXECUTE FUNCTION generar_numero_historia()
    trigger_pacientes_fecha_actualizacion BEFORE UPDATE ON pacientes FOR EACH ROW EXECUTE FUNCTION actualizar_fecha_modificacion()
Access method: heap

```

---

## TABLA: `historial_medico`

```
                                                                 Table "public.historial_medico"
          Column          |           Type           | Collation | Nullable |            Default            | Storage  | Compression | Stats target | Description 
--------------------------+--------------------------+-----------+----------+-------------------------------+----------+-------------+--------------+-------------
 id                       | uuid                     |           | not null | uuid_generate_v4()            | plain    |             |              | 
 paciente_id              | uuid                     |           | not null |                               | plain    |             |              | 
 consulta_id              | uuid                     |           |          |                               | plain    |             |              | 
 intervencion_id          | uuid                     |           |          |                               | plain    |             |              | 
 odontologo_id            | uuid                     |           | not null |                               | plain    |             |              | 
 fecha_registro           | timestamp with time zone |           |          | CURRENT_TIMESTAMP             | plain    |             |              | 
 tipo_registro            | character varying(30)    |           |          | 'consulta'::character varying | extended |             |              | 
 sintomas_principales     | text                     |           |          |                               | extended |             |              | 
 examen_clinico           | text                     |           |          |                               | extended |             |              | 
 diagnostico_principal    | text                     |           |          |                               | extended |             |              | 
 diagnosticos_secundarios | text[]                   |           |          |                               | extended |             |              | 
 plan_tratamiento         | text                     |           |          |                               | extended |             |              | 
 pronostico               | text                     |           |          |                               | extended |             |              | 
 medicamentos_recetados   | jsonb                    |           |          | '[]'::jsonb                   | extended |             |              | 
 recomendaciones          | text                     |           |          |                               | extended |             |              | 
 contraindicaciones       | text                     |           |          |                               | extended |             |              | 
 presion_arterial         | character varying(20)    |           |          |                               | extended |             |              | 
 frecuencia_cardiaca      | integer                  |           |          |                               | plain    |             |              | 
 temperatura              | numeric(4,2)             |           |          |                               | main     |             |              | 
 imagenes_url             | text[]                   |           |          |                               | extended |             |              | 
 documentos_url           | text[]                   |           |          |                               | extended |             |              | 
 proxima_consulta         | date                     |           |          |                               | plain    |             |              | 
 observaciones            | text                     |           |          |                               | extended |             |              | 
 confidencial             | boolean                  |           |          | false                         | plain    |             |              | 
Indexes:
    "historial_medico_pkey" PRIMARY KEY, btree (id)
Check constraints:
    "chk_historial_frecuencia" CHECK (frecuencia_cardiaca IS NULL OR frecuencia_cardiaca >= 40 AND frecuencia_cardiaca <= 200)
    "chk_historial_temperatura" CHECK (temperatura IS NULL OR temperatura >= 30::numeric AND temperatura <= 45::numeric)
    "historial_medico_tipo_registro_check" CHECK (tipo_registro::text = ANY (ARRAY['consulta'::character varying, 'tratamiento'::character varying, 'control'::character varying, 'urgencia'::character varying, 'nota'::character varying]::text[]))
Foreign-key constraints:
    "historial_medico_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    "historial_medico_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id)
    "historial_medico_odontologo_id_fkey" FOREIGN KEY (odontologo_id) REFERENCES personal(id)
    "historial_medico_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
Policies:
    POLICY "historial_medico_policy"
      USING (true)
Access method: heap

```

---

## TABLA: `imagenes_clinicas`

```
                                                         Table "public.imagenes_clinicas"
        Column        |           Type           | Collation | Nullable |      Default       | Storage  | Compression | Stats target | Description 
----------------------+--------------------------+-----------+----------+--------------------+----------+-------------+--------------+-------------
 id                   | uuid                     |           | not null | uuid_generate_v4() | plain    |             |              | 
 paciente_id          | uuid                     |           | not null |                    | plain    |             |              | 
 consulta_id          | uuid                     |           |          |                    | plain    |             |              | 
 intervencion_id      | uuid                     |           |          |                    | plain    |             |              | 
 odontograma_id       | uuid                     |           |          |                    | plain    |             |              | 
 titulo               | character varying(200)   |           | not null |                    | extended |             |              | 
 descripcion          | text                     |           |          |                    | extended |             |              | 
 tipo_imagen          | character varying(50)    |           | not null |                    | extended |             |              | 
 url_imagen           | text                     |           | not null |                    | extended |             |              | 
 url_thumbnail        | text                     |           |          |                    | extended |             |              | 
 tamaño_archivo       | bigint                   |           |          |                    | plain    |             |              | 
 formato_archivo      | character varying(10)    |           |          |                    | extended |             |              | 
 fecha_captura        | timestamp with time zone |           |          | CURRENT_TIMESTAMP  | plain    |             |              | 
 capturada_por        | uuid                     |           |          |                    | plain    |             |              | 
 equipo_utilizado     | character varying(100)   |           |          |                    | extended |             |              | 
 configuracion_equipo | jsonb                    |           |          | '{}'::jsonb        | extended |             |              | 
 anotaciones_imagen   | jsonb                    |           |          | '[]'::jsonb        | extended |             |              | 
 dientes_visibles     | integer[]                |           |          |                    | extended |             |              | 
 es_confidencial      | boolean                  |           |          | false              | plain    |             |              | 
 tags                 | text[]                   |           |          |                    | extended |             |              | 
 activo               | boolean                  |           |          | true               | plain    |             |              | 
Indexes:
    "imagenes_clinicas_pkey" PRIMARY KEY, btree (id)
Check constraints:
    "imagenes_clinicas_tipo_imagen_check" CHECK (tipo_imagen::text = ANY (ARRAY['radiografia_panoramica'::character varying, 'radiografia_periapical'::character varying, 'radiografia_bite_wing'::character varying, 'fotografia_intraoral'::character varying, 'fotografia_extraoral'::character varying, 'fotografia_oclusal'::character varying, 'tomografia'::character varying, 'escaner_3d'::character varying, 'antes_tratamiento'::character varying, 'despues_tratamiento'::character varying, 'otro'::character varying]::text[]))
Foreign-key constraints:
    "imagenes_clinicas_capturada_por_fkey" FOREIGN KEY (capturada_por) REFERENCES usuarios(id)
    "imagenes_clinicas_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    "imagenes_clinicas_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id)
    "imagenes_clinicas_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
Access method: heap

```

---

## TABLA: `consultas`

```
                                                                    Table "public.consultas"
        Column         |           Type           | Collation | Nullable |            Default             | Storage  | Compression | Stats target | Description 
-----------------------+--------------------------+-----------+----------+--------------------------------+----------+-------------+--------------+-------------
 id                    | uuid                     |           | not null | uuid_generate_v4()             | plain    |             |              | 
 numero_consulta       | character varying(20)    |           | not null |                                | extended |             |              | 
 paciente_id           | uuid                     |           | not null |                                | plain    |             |              | 
 primer_odontologo_id  | uuid                     |           | not null |                                | plain    |             |              | 
 fecha_llegada         | timestamp with time zone |           | not null | CURRENT_TIMESTAMP              | plain    |             |              | 
 orden_llegada_general | integer                  |           |          |                                | plain    |             |              | 
 orden_cola_odontologo | integer                  |           |          |                                | plain    |             |              | 
 estado                | character varying(20)    |           |          | 'en_espera'::character varying | extended |             |              | 
 tipo_consulta         | character varying(30)    |           |          | 'general'::character varying   | extended |             |              | 
 prioridad             | character varying(20)    |           |          | 'normal'::character varying    | extended |             |              | 
 motivo_consulta       | text                     |           |          |                                | extended |             |              | 
 observaciones         | text                     |           |          |                                | extended |             |              | 
 costo_total_bs        | numeric(10,2)            |           |          | 0                              | main     |             |              | 
 costo_total_usd       | numeric(10,2)            |           |          | 0                              | main     |             |              | 
 creada_por            | uuid                     |           |          |                                | plain    |             |              | 
 fecha_creacion        | timestamp with time zone |           |          | CURRENT_TIMESTAMP              | plain    |             |              | 
 fecha_actualizacion   | timestamp with time zone |           |          | CURRENT_TIMESTAMP              | plain    |             |              | 
Indexes:
    "consultas_pkey" PRIMARY KEY, btree (id)
    "consultas_numero_consulta_key" UNIQUE CONSTRAINT, btree (numero_consulta)
    "idx_consultas_cola_odontologo" btree (primer_odontologo_id, orden_cola_odontologo)
    "idx_consultas_estado_fecha" btree (estado, fecha_llegada)
    "idx_consultas_orden_general" btree (orden_llegada_general)
    "idx_consultas_paciente_fecha" btree (paciente_id, fecha_llegada)
    "idx_consultas_primer_odontologo" btree (primer_odontologo_id, fecha_llegada)
Check constraints:
    "chk_consultas_costos" CHECK (costo_total_bs >= 0::numeric AND costo_total_usd >= 0::numeric)
    "consultas_estado_check" CHECK (estado::text = ANY (ARRAY['en_espera'::character varying, 'en_atencion'::character varying, 'entre_odontologos'::character varying, 'completada'::character varying, 'cancelada'::character varying]::text[]))
    "consultas_prioridad_check" CHECK (prioridad::text = ANY (ARRAY['baja'::character varying, 'normal'::character varying, 'alta'::character varying, 'urgente'::character varying]::text[]))
    "consultas_tipo_consulta_check" CHECK (tipo_consulta::text = ANY (ARRAY['general'::character varying, 'control'::character varying, 'urgencia'::character varying, 'emergencia'::character varying]::text[]))
Foreign-key constraints:
    "consultas_creada_por_fkey" FOREIGN KEY (creada_por) REFERENCES usuarios(id)
    "consultas_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
    "consultas_primer_odontologo_id_fkey" FOREIGN KEY (primer_odontologo_id) REFERENCES personal(id)
Referenced by:
    TABLE "historial_medico" CONSTRAINT "historial_medico_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    TABLE "imagenes_clinicas" CONSTRAINT "imagenes_clinicas_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    TABLE "intervenciones" CONSTRAINT "intervenciones_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    TABLE "pagos" CONSTRAINT "pagos_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
Policies:
    POLICY "consultas_policy"
      USING (true)
Triggers:
    trigger_asignar_orden_llegada BEFORE INSERT ON consultas FOR EACH ROW EXECUTE FUNCTION asignar_orden_llegada()
    trigger_consultas_fecha_actualizacion BEFORE UPDATE ON consultas FOR EACH ROW EXECUTE FUNCTION actualizar_fecha_modificacion()
    trigger_generar_numero_consulta BEFORE INSERT ON consultas FOR EACH ROW EXECUTE FUNCTION generar_numero_consulta()
Access method: heap

```

---

## TABLA: `intervenciones`

```
                                                                   Table "public.intervenciones"
         Column          |           Type           | Collation | Nullable |             Default             | Storage  | Compression | Stats target | Description 
-------------------------+--------------------------+-----------+----------+---------------------------------+----------+-------------+--------------+-------------
 id                      | uuid                     |           | not null | uuid_generate_v4()              | plain    |             |              | 
 consulta_id             | uuid                     |           | not null |                                 | plain    |             |              | 
 odontologo_id           | uuid                     |           | not null |                                 | plain    |             |              | 
 asistente_id            | uuid                     |           |          |                                 | plain    |             |              | 
 hora_inicio             | timestamp with time zone |           | not null | CURRENT_TIMESTAMP               | plain    |             |              | 
 hora_fin                | timestamp with time zone |           |          |                                 | plain    |             |              | 
 duracion_real           | interval                 |           |          |                                 | plain    |             |              | 
 dientes_afectados       | integer[]                |           |          |                                 | extended |             |              | 
 diagnostico_inicial     | text                     |           |          |                                 | extended |             |              | 
 procedimiento_realizado | text                     |           | not null |                                 | extended |             |              | 
 materiales_utilizados   | text[]                   |           |          |                                 | extended |             |              | 
 anestesia_utilizada     | text                     |           |          |                                 | extended |             |              | 
 complicaciones          | text                     |           |          |                                 | extended |             |              | 
 total_bs                | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 total_usd               | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 descuento_bs            | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 descuento_usd           | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 estado                  | character varying(20)    |           |          | 'completada'::character varying | extended |             |              | 
 requiere_control        | boolean                  |           |          | false                           | plain    |             |              | 
 fecha_control_sugerida  | date                     |           |          |                                 | plain    |             |              | 
 instrucciones_paciente  | text                     |           |          |                                 | extended |             |              | 
 cambios_odontograma     | jsonb                    |           |          | '[]'::jsonb                     | extended |             |              | 
 fecha_registro          | timestamp with time zone |           |          | CURRENT_TIMESTAMP               | plain    |             |              | 
Indexes:
    "intervenciones_pkey" PRIMARY KEY, btree (id)
    "idx_intervenciones_consulta" btree (consulta_id)
    "idx_intervenciones_estado" btree (estado)
    "idx_intervenciones_odontologo_fecha" btree (odontologo_id, hora_inicio)
Check constraints:
    "chk_intervenciones_descuentos" CHECK (descuento_bs >= 0::numeric AND descuento_usd >= 0::numeric)
    "chk_intervenciones_totales" CHECK (total_bs >= 0::numeric AND total_usd >= 0::numeric)
    "intervenciones_estado_check" CHECK (estado::text = ANY (ARRAY['en_progreso'::character varying, 'completada'::character varying, 'suspendida'::character varying]::text[]))
Foreign-key constraints:
    "intervenciones_asistente_id_fkey" FOREIGN KEY (asistente_id) REFERENCES personal(id)
    "intervenciones_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    "intervenciones_odontologo_id_fkey" FOREIGN KEY (odontologo_id) REFERENCES personal(id)
Referenced by:
    TABLE "condiciones_diente" CONSTRAINT "condiciones_diente_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id) ON DELETE SET NULL
    TABLE "historial_medico" CONSTRAINT "historial_medico_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id)
    TABLE "imagenes_clinicas" CONSTRAINT "imagenes_clinicas_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id)
    TABLE "intervenciones_servicios" CONSTRAINT "intervenciones_servicios_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id) ON DELETE CASCADE
Policies:
    POLICY "intervenciones_policy"
      USING (true)
Triggers:
    trigger_actualizar_costos_consulta AFTER INSERT OR DELETE OR UPDATE ON intervenciones FOR EACH ROW EXECUTE FUNCTION actualizar_costos_consulta()
Access method: heap

```

---

## TABLA: `intervenciones_servicios`

```
                                                                                             Table "public.intervenciones_servicios"
         Column         |           Type           | Collation | Nullable |      Default       | Storage  | Compression | Stats target |                                       Description                                        
------------------------+--------------------------+-----------+----------+--------------------+----------+-------------+--------------+------------------------------------------------------------------------------------------
 id                     | uuid                     |           | not null | uuid_generate_v4() | plain    |             |              | 
 intervencion_id        | uuid                     |           | not null |                    | plain    |             |              | 
 servicio_id            | uuid                     |           | not null |                    | plain    |             |              | 
 cantidad               | integer                  |           |          | 1                  | plain    |             |              | 
 precio_unitario_bs     | numeric(10,2)            |           | not null |                    | main     |             |              | 
 precio_unitario_usd    | numeric(10,2)            |           | not null |                    | main     |             |              | 
 precio_total_bs        | numeric(10,2)            |           | not null |                    | main     |             |              | 
 precio_total_usd       | numeric(10,2)            |           | not null |                    | main     |             |              | 
 dientes_especificos    | integer[]                |           |          |                    | extended |             |              | 
 observaciones_servicio | text                     |           |          |                    | extended |             |              | 
 fecha_registro         | timestamp with time zone |           |          | CURRENT_TIMESTAMP  | plain    |             |              | 
 diente_numero          | integer                  |           |          |                    | plain    |             |              | Número FDI del diente (11-48). NULL para servicios de boca completa.
 superficie             | character varying(20)    |           |          |                    | extended |             |              | Superficie específica del diente. NULL para servicio de diente completo o boca completa.
Indexes:
    "intervenciones_servicios_pkey" PRIMARY KEY, btree (id)
    "idx_interv_servicios_diente" btree (diente_numero)
    "idx_interv_servicios_diente_superficie" btree (diente_numero, superficie)
    "idx_interv_servicios_intervencion" btree (intervencion_id)
    "idx_interv_servicios_servicio" btree (servicio_id)
Check constraints:
    "chk_interv_serv_precios" CHECK (precio_unitario_bs >= 0::numeric AND precio_unitario_usd >= 0::numeric AND precio_total_bs = (cantidad::numeric * precio_unitario_bs) AND precio_total_usd = (cantidad::numeric * precio_unitario_usd))
    "intervenciones_servicios_cantidad_check" CHECK (cantidad > 0)
Foreign-key constraints:
    "intervenciones_servicios_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id) ON DELETE CASCADE
    "intervenciones_servicios_servicio_id_fkey" FOREIGN KEY (servicio_id) REFERENCES servicios(id)
Triggers:
    trigger_calcular_totales_intervencion AFTER INSERT OR DELETE OR UPDATE ON intervenciones_servicios FOR EACH ROW EXECUTE FUNCTION calcular_totales_intervencion()
Access method: heap

```

---

## TABLA: `condiciones_diente`

```
                                                           Table "public.condiciones_diente"
     Column      |           Type           | Collation | Nullable |           Default            | Storage  | Compression | Stats target | Description 
-----------------+--------------------------+-----------+----------+------------------------------+----------+-------------+--------------+-------------
 id              | uuid                     |           | not null | gen_random_uuid()            | plain    |             |              | 
 paciente_id     | uuid                     |           | not null |                              | plain    |             |              | 
 diente_numero   | integer                  |           | not null |                              | plain    |             |              | 
 superficie      | character varying(20)    |           | not null |                              | extended |             |              | 
 tipo_condicion  | character varying(50)    |           | not null |                              | extended |             |              | 
 severidad       | character varying(20)    |           |          | 'leve'::character varying    | extended |             |              | 
 descripcion     | text                     |           |          |                              | extended |             |              | 
 intervencion_id | uuid                     |           |          |                              | plain    |             |              | 
 registrado_por  | uuid                     |           |          |                              | plain    |             |              | 
 fecha_registro  | timestamp with time zone |           | not null | CURRENT_TIMESTAMP            | plain    |             |              | 
 activo          | boolean                  |           | not null | true                         | plain    |             |              | 
 color_hex       | character varying(7)     |           |          | '#90EE90'::character varying | extended |             |              | 
 created_at      | timestamp with time zone |           |          | CURRENT_TIMESTAMP            | plain    |             |              | 
 updated_at      | timestamp with time zone |           |          | CURRENT_TIMESTAMP            | plain    |             |              | 
Indexes:
    "condiciones_diente_pkey" PRIMARY KEY, btree (id)
    "idx_condiciones_diente_numero" btree (diente_numero)
    "idx_condiciones_fecha" btree (fecha_registro DESC)
    "idx_condiciones_intervencion" btree (intervencion_id)
    "idx_condiciones_paciente_activo" btree (paciente_id, activo)
    "unique_active_condition" UNIQUE, btree (paciente_id, diente_numero, superficie) WHERE activo = true
Check constraints:
    "condiciones_diente_severidad_check" CHECK (severidad::text = ANY (ARRAY['leve'::character varying, 'moderada'::character varying, 'severa'::character varying]::text[]))
    "condiciones_diente_superficie_check" CHECK (superficie::text = ANY (ARRAY['mesial'::character varying, 'distal'::character varying, 'oclusal'::character varying, 'lingual'::character varying, 'vestibular'::character varying, 'completo'::character varying]::text[]))
    "condiciones_diente_tipo_condicion_check" CHECK (tipo_condicion::text = ANY (ARRAY['sano'::character varying, 'caries'::character varying, 'obturacion'::character varying, 'corona'::character varying, 'puente'::character varying, 'implante'::character varying, 'ausente'::character varying, 'extraccion_indicada'::character varying, 'endodoncia'::character varying, 'protesis'::character varying, 'fractura'::character varying, 'mancha'::character varying, 'desgaste'::character varying, 'sensibilidad'::character varying, 'movilidad'::character varying, 'impactado'::character varying, 'en_erupcion'::character varying, 'retenido'::character varying, 'supernumerario'::character varying, 'otro'::character varying]::text[]))
Foreign-key constraints:
    "condiciones_diente_intervencion_id_fkey" FOREIGN KEY (intervencion_id) REFERENCES intervenciones(id) ON DELETE SET NULL
    "condiciones_diente_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id) ON DELETE CASCADE
    "condiciones_diente_registrado_por_fkey" FOREIGN KEY (registrado_por) REFERENCES usuarios(id)
Access method: heap

```

---

## TABLA: `dientes`

```
                                                                                                  Table "public.dientes"
        Column         |          Type          | Collation | Nullable |                                           Default                                           | Storage  | Compression | Stats target | Description 
-----------------------+------------------------+-----------+----------+---------------------------------------------------------------------------------------------+----------+-------------+--------------+-------------
 id                    | uuid                   |           | not null | uuid_generate_v4()                                                                          | plain    |             |              | 
 numero_diente         | integer                |           | not null |                                                                                             | plain    |             |              | 
 nombre                | character varying(100) |           | not null |                                                                                             | extended |             |              | 
 tipo_diente           | character varying(20)  |           | not null |                                                                                             | extended |             |              | 
 ubicacion             | character varying(30)  |           | not null |                                                                                             | extended |             |              | 
 cuadrante             | integer                |           | not null |                                                                                             | plain    |             |              | 
 es_temporal           | boolean                |           |          | false                                                                                       | plain    |             |              | 
 posicion_en_cuadrante | integer                |           |          |                                                                                             | plain    |             |              | 
 caras                 | text[]                 |           |          | ARRAY['oclusal'::text, 'mesial'::text, 'distal'::text, 'vestibular'::text, 'lingual'::text] | extended |             |              | 
 activo                | boolean                |           |          | true                                                                                        | plain    |             |              | 
Indexes:
    "dientes_pkey" PRIMARY KEY, btree (id)
    "dientes_numero_diente_key" UNIQUE CONSTRAINT, btree (numero_diente)
Check constraints:
    "dientes_cuadrante_check" CHECK (cuadrante = ANY (ARRAY[1, 2, 3, 4, 5, 6, 7, 8]))
    "dientes_tipo_diente_check" CHECK (tipo_diente::text = ANY (ARRAY['incisivo'::character varying, 'canino'::character varying, 'premolar'::character varying, 'molar'::character varying]::text[]))
    "dientes_ubicacion_check" CHECK (ubicacion::text = ANY (ARRAY['superior_derecha'::character varying, 'superior_izquierda'::character varying, 'inferior_derecha'::character varying, 'inferior_izquierda'::character varying]::text[]))
Access method: heap

```

---

## TABLA: `pagos`

```
                                                                     Table "public.pagos"
       Column        |           Type           | Collation | Nullable |             Default             | Storage  | Compression | Stats target | Description 
---------------------+--------------------------+-----------+----------+---------------------------------+----------+-------------+--------------+-------------
 id                  | uuid                     |           | not null | uuid_generate_v4()              | plain    |             |              | 
 numero_recibo       | character varying(20)    |           | not null |                                 | extended |             |              | 
 consulta_id         | uuid                     |           |          |                                 | plain    |             |              | 
 paciente_id         | uuid                     |           | not null |                                 | plain    |             |              | 
 fecha_pago          | timestamp with time zone |           |          | CURRENT_TIMESTAMP               | plain    |             |              | 
 monto_total_bs      | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 monto_total_usd     | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 monto_pagado_bs     | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 monto_pagado_usd    | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 saldo_pendiente_bs  | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 saldo_pendiente_usd | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 tasa_cambio_bs_usd  | numeric(10,4)            |           |          |                                 | main     |             |              | 
 metodos_pago        | jsonb                    |           |          | '[]'::jsonb                     | extended |             |              | 
 concepto            | text                     |           | not null |                                 | extended |             |              | 
 descuento_usd       | numeric(10,2)            |           |          | 0                               | main     |             |              | 
 motivo_descuento    | text                     |           |          |                                 | extended |             |              | 
 estado_pago         | character varying(20)    |           |          | 'completado'::character varying | extended |             |              | 
 procesado_por       | uuid                     |           | not null |                                 | plain    |             |              | 
 autorizado_por      | uuid                     |           |          |                                 | plain    |             |              | 
 numero_factura      | character varying(50)    |           |          |                                 | extended |             |              | 
 fecha_facturacion   | date                     |           |          |                                 | plain    |             |              | 
 observaciones       | text                     |           |          |                                 | extended |             |              | 
Indexes:
    "pagos_pkey" PRIMARY KEY, btree (id)
    "idx_pagos_estado_fecha" btree (estado_pago, fecha_pago)
    "idx_pagos_numero_recibo" btree (numero_recibo)
    "idx_pagos_paciente_fecha" btree (paciente_id, fecha_pago)
    "pagos_numero_recibo_key" UNIQUE CONSTRAINT, btree (numero_recibo)
Check constraints:
    "chk_pagos_montos" CHECK (monto_total_bs >= 0::numeric AND monto_total_usd >= 0::numeric AND monto_pagado_bs >= 0::numeric AND monto_pagado_usd >= 0::numeric AND saldo_pendiente_bs >= 0::numeric AND saldo_pendiente_usd >= 0::numeric)
    "pagos_estado_pago_check" CHECK (estado_pago::text = ANY (ARRAY['pendiente'::character varying, 'completado'::character varying, 'parcial'::character varying, 'anulado'::character varying, 'reembolsado'::character varying]::text[]))
Foreign-key constraints:
    "pagos_autorizado_por_fkey" FOREIGN KEY (autorizado_por) REFERENCES usuarios(id)
    "pagos_consulta_id_fkey" FOREIGN KEY (consulta_id) REFERENCES consultas(id)
    "pagos_paciente_id_fkey" FOREIGN KEY (paciente_id) REFERENCES pacientes(id)
    "pagos_procesado_por_fkey" FOREIGN KEY (procesado_por) REFERENCES usuarios(id)
Policies:
    POLICY "pagos_policy"
      USING (true)
Triggers:
    trigger_calcular_saldos_pago BEFORE INSERT OR UPDATE ON pagos FOR EACH ROW EXECUTE FUNCTION calcular_saldos_pago()
    trigger_generar_numero_recibo BEFORE INSERT ON pagos FOR EACH ROW EXECUTE FUNCTION generar_numero_recibo()
Access method: heap

```

---

## TABLA: `pagos_secuencias`

```
                                               Table "public.pagos_secuencias"
    Column     |         Type         | Collation | Nullable | Default | Storage  | Compression | Stats target | Description 
---------------+----------------------+-----------+----------+---------+----------+-------------+--------------+-------------
 año_mes       | character varying(6) |           | not null |         | extended |             |              | 
 ultimo_numero | integer              |           | not null | 0       | plain    |             |              | 
Indexes:
    "pagos_secuencias_pkey" PRIMARY KEY, btree ("año_mes")
Access method: heap

```

---

## VISTAS

### VISTA: `verificacion_limpieza`

```
                     View "public.verificacion_limpieza"
   Column    | Type | Collation | Nullable | Default | Storage  | Description 
-------------+------+-----------+----------+---------+----------+-------------
 schemaname  | name |           |          |         | plain    | 
 tablename   | name |           |          |         | plain    | 
 size_pretty | text |           |          |         | extended | 
View definition:
 SELECT schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(((schemaname::text || '.'::text) || tablename::text)::regclass)) AS size_pretty
   FROM pg_tables
  WHERE schemaname = 'public'::name
  ORDER BY tablename;

```

### VISTA: `vista_cola_odontologos`

```
                                    View "public.vista_cola_odontologos"
         Column          |          Type          | Collation | Nullable | Default | Storage  | Description 
-------------------------+------------------------+-----------+----------+---------+----------+-------------
 odontologo_id           | uuid                   |           |          |         | plain    | 
 odontologo_nombre       | text                   |           |          |         | extended | 
 especialidad            | character varying(100) |           |          |         | extended | 
 acepta_pacientes_nuevos | boolean                |           |          |         | plain    | 
 pacientes_esperando     | bigint                 |           |          |         | plain    | 
 pacientes_atendiendo    | bigint                 |           |          |         | plain    | 
 pacientes_atendidos_hoy | bigint                 |           |          |         | plain    | 
 proximo_en_cola         | integer                |           |          |         | plain    | 
View definition:
 SELECT pers.id AS odontologo_id,
    TRIM(BOTH FROM concat(pers.primer_nombre, ' ', COALESCE(pers.segundo_nombre, ''::character varying), ' ', pers.primer_apellido, ' ', COALESCE(pers.segundo_apellido, ''::character varying))) AS odontologo_nombre,
    pers.especialidad,
    pers.acepta_pacientes_nuevos,
    count(
        CASE
            WHEN c.estado::text = 'en_espera'::text THEN 1
            ELSE NULL::integer
        END) AS pacientes_esperando,
    count(
        CASE
            WHEN c.estado::text = 'en_atencion'::text AND c.primer_odontologo_id = pers.id THEN 1
            ELSE NULL::integer
        END) AS pacientes_atendiendo,
    count(
        CASE
            WHEN c.estado::text = 'completada'::text AND date(c.fecha_llegada) = CURRENT_DATE THEN 1
            ELSE NULL::integer
        END) AS pacientes_atendidos_hoy,
    min(
        CASE
            WHEN c.estado::text = 'en_espera'::text THEN c.orden_cola_odontologo
            ELSE NULL::integer
        END) AS proximo_en_cola
   FROM personal pers
     LEFT JOIN consultas c ON pers.id = c.primer_odontologo_id AND date(c.fecha_llegada) = CURRENT_DATE
  WHERE pers.tipo_personal::text = 'Odontólogo'::text AND pers.estado_laboral::text = 'activo'::text
  GROUP BY pers.id, pers.primer_nombre, pers.segundo_nombre, pers.primer_apellido, pers.segundo_apellido, pers.especialidad, pers.acepta_pacientes_nuevos
  ORDER BY (count(
        CASE
            WHEN c.estado::text = 'en_espera'::text THEN 1
            ELSE NULL::integer
        END)), pers.orden_preferencia;

```

### VISTA: `vista_personal_completo`

```
                                    View "public.vista_personal_completo"
         Column          |           Type           | Collation | Nullable | Default | Storage  | Description 
-------------------------+--------------------------+-----------+----------+---------+----------+-------------
 id                      | uuid                     |           |          |         | plain    | 
 numero_documento        | character varying(20)    |           |          |         | extended | 
 tipo_documento          | character varying(20)    |           |          |         | extended | 
 fecha_nacimiento        | date                     |           |          |         | plain    | 
 direccion               | character varying(200)   |           |          |         | extended | 
 celular                 | character varying(20)    |           |          |         | extended | 
 tipo_personal           | character varying(20)    |           |          |         | extended | 
 especialidad            | character varying(100)   |           |          |         | extended | 
 numero_licencia         | character varying(50)    |           |          |         | extended | 
 fecha_contratacion      | date                     |           |          |         | plain    | 
 salario                 | numeric(10,2)            |           |          |         | main     | 
 estado_laboral          | character varying(20)    |           |          |         | extended | 
 observaciones           | text                     |           |          |         | extended | 
 primer_nombre           | character varying(50)    |           |          |         | extended | 
 segundo_nombre          | character varying(50)    |           |          |         | extended | 
 primer_apellido         | character varying(50)    |           |          |         | extended | 
 segundo_apellido        | character varying(50)    |           |          |         | extended | 
 acepta_pacientes_nuevos | boolean                  |           |          |         | plain    | 
 orden_preferencia       | integer                  |           |          |         | plain    | 
 usuario_id              | uuid                     |           |          |         | plain    | 
 email                   | character varying(100)   |           |          |         | extended | 
 usuario_activo          | boolean                  |           |          |         | plain    | 
 ultimo_acceso           | timestamp with time zone |           |          |         | plain    | 
 fecha_creacion          | timestamp with time zone |           |          |         | plain    | 
 auth_user_id            | uuid                     |           |          |         | plain    | 
 avatar_url              | text                     |           |          |         | extended | 
 metadata                | jsonb                    |           |          |         | extended | 
 configuraciones         | jsonb                    |           |          |         | extended | 
 rol_id                  | uuid                     |           |          |         | plain    | 
 rol_nombre              | character varying(50)    |           |          |         | extended | 
 rol_descripcion         | text                     |           |          |         | extended | 
 rol_permisos            | jsonb                    |           |          |         | extended | 
 nombre_completo         | text                     |           |          |         | extended | 
 completamente_activo    | boolean                  |           |          |         | plain    | 
 dias_en_empresa         | integer                  |           |          |         | plain    | 
 usuario_info            | jsonb                    |           |          |         | extended | 
View definition:
 SELECT p.id,
    p.numero_documento,
    p.tipo_documento,
    p.fecha_nacimiento,
    p.direccion,
    p.celular,
    p.tipo_personal,
    p.especialidad,
    p.numero_licencia,
    p.fecha_contratacion,
    p.salario,
    p.estado_laboral,
    p.observaciones,
    p.primer_nombre,
    p.segundo_nombre,
    p.primer_apellido,
    p.segundo_apellido,
    p.acepta_pacientes_nuevos,
    p.orden_preferencia,
    p.usuario_id,
    u.email,
    u.activo AS usuario_activo,
    u.ultimo_acceso,
    u.fecha_creacion,
    u.auth_user_id,
    u.avatar_url,
    u.metadata,
    u.configuraciones,
    r.id AS rol_id,
    r.nombre AS rol_nombre,
    r.descripcion AS rol_descripcion,
    r.permisos AS rol_permisos,
        CASE
            WHEN p.id IS NOT NULL THEN TRIM(BOTH FROM concat(COALESCE(p.primer_nombre, ''::character varying),
            CASE
                WHEN p.segundo_nombre IS NOT NULL AND p.segundo_nombre::text <> ''::text THEN ' '::text || p.segundo_nombre::text
                ELSE ''::text
            END, ' ', COALESCE(p.primer_apellido, ''::character varying),
            CASE
                WHEN p.segundo_apellido IS NOT NULL AND p.segundo_apellido::text <> ''::text THEN ' '::text || p.segundo_apellido::text
                ELSE ''::text
            END))
            ELSE split_part(u.email::text, '@'::text, 1)
        END AS nombre_completo,
        CASE
            WHEN p.estado_laboral::text = 'activo'::text AND u.activo = true THEN true
            ELSE false
        END AS completamente_activo,
        CASE
            WHEN p.fecha_contratacion IS NOT NULL THEN CURRENT_DATE - p.fecha_contratacion
            ELSE NULL::integer
        END AS dias_en_empresa,
    jsonb_build_object('id', u.id, 'email', u.email, 'activo', u.activo, 'auth_user_id', u.auth_user_id, 'nombre_completo',
        CASE
            WHEN p.id IS NOT NULL THEN TRIM(BOTH FROM concat(COALESCE(p.primer_nombre, ''::character varying),
            CASE
                WHEN p.segundo_nombre IS NOT NULL AND p.segundo_nombre::text <> ''::text THEN ' '::text || p.segundo_nombre::text
                ELSE ''::text
            END, ' ', COALESCE(p.primer_apellido, ''::character varying),
            CASE
                WHEN p.segundo_apellido IS NOT NULL AND p.segundo_apellido::text <> ''::text THEN ' '::text || p.segundo_apellido::text
                ELSE ''::text
            END))
            ELSE split_part(u.email::text, '@'::text, 1)
        END) AS usuario_info
   FROM personal p
     JOIN usuarios u ON p.usuario_id = u.id
     JOIN roles r ON u.rol_id = r.id
  ORDER BY (
        CASE
            WHEN p.id IS NOT NULL THEN TRIM(BOTH FROM concat(COALESCE(p.primer_nombre, ''::character varying), ' ', COALESCE(p.primer_apellido, ''::character varying)))::character varying
            ELSE u.email
        END);

```

---

## TRIGGERS

```
             trigger_name              |    event_object_table    | action_timing | event_manipulation |                 action_statement                 
---------------------------------------+--------------------------+---------------+--------------------+--------------------------------------------------
 trigger_asignar_orden_llegada         | consultas                | BEFORE        | INSERT             | EXECUTE FUNCTION asignar_orden_llegada()
 trigger_consultas_fecha_actualizacion | consultas                | BEFORE        | UPDATE             | EXECUTE FUNCTION actualizar_fecha_modificacion()
 trigger_generar_numero_consulta       | consultas                | BEFORE        | INSERT             | EXECUTE FUNCTION generar_numero_consulta()
 trigger_actualizar_costos_consulta    | intervenciones           | AFTER         | UPDATE             | EXECUTE FUNCTION actualizar_costos_consulta()
 trigger_actualizar_costos_consulta    | intervenciones           | AFTER         | INSERT             | EXECUTE FUNCTION actualizar_costos_consulta()
 trigger_actualizar_costos_consulta    | intervenciones           | AFTER         | DELETE             | EXECUTE FUNCTION actualizar_costos_consulta()
 trigger_calcular_totales_intervencion | intervenciones_servicios | AFTER         | INSERT             | EXECUTE FUNCTION calcular_totales_intervencion()
 trigger_calcular_totales_intervencion | intervenciones_servicios | AFTER         | DELETE             | EXECUTE FUNCTION calcular_totales_intervencion()
 trigger_calcular_totales_intervencion | intervenciones_servicios | AFTER         | UPDATE             | EXECUTE FUNCTION calcular_totales_intervencion()
 trigger_calcular_edad_paciente        | pacientes                | BEFORE        | UPDATE             | EXECUTE FUNCTION calcular_edad_paciente()
 trigger_calcular_edad_paciente        | pacientes                | BEFORE        | INSERT             | EXECUTE FUNCTION calcular_edad_paciente()
 trigger_crear_odontograma_inicial     | pacientes                | AFTER         | INSERT             | EXECUTE FUNCTION crear_odontograma_inicial()
 trigger_generar_numero_historia       | pacientes                | BEFORE        | INSERT             | EXECUTE FUNCTION generar_numero_historia()
 trigger_pacientes_fecha_actualizacion | pacientes                | BEFORE        | UPDATE             | EXECUTE FUNCTION actualizar_fecha_modificacion()
 trigger_calcular_saldos_pago          | pagos                    | BEFORE        | UPDATE             | EXECUTE FUNCTION calcular_saldos_pago()
 trigger_calcular_saldos_pago          | pagos                    | BEFORE        | INSERT             | EXECUTE FUNCTION calcular_saldos_pago()
 trigger_generar_numero_recibo         | pagos                    | BEFORE        | INSERT             | EXECUTE FUNCTION generar_numero_recibo()
 trigger_personal_fecha_actualizacion  | personal                 | BEFORE        | UPDATE             | EXECUTE FUNCTION actualizar_fecha_modificacion()
 trigger_usuarios_fecha_actualizacion  | usuarios                 | BEFORE        | UPDATE             | EXECUTE FUNCTION actualizar_fecha_modificacion()
(19 rows)

```

---

## FUNCIONES

```
                  proname                  |                                                                                                                                                                            pg_get_functiondef                                                                                                                                                                             
-------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 actualizar_condicion_diente               | CREATE OR REPLACE FUNCTION public.actualizar_condicion_diente(p_paciente_id uuid, p_diente_numero integer, p_superficie character varying, p_nueva_condicion character varying, p_intervencion_id uuid DEFAULT NULL::uuid, p_material character varying DEFAULT NULL::character varying, p_descripcion text DEFAULT NULL::text, p_registrado_por uuid DEFAULT NULL::uuid)+
                                           |  RETURNS uuid                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$                                                                                                                                                                                                                                                                                                                                                            +
                                           | DECLARE                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     nueva_condicion_id UUID;                                                                                                                                                                                                                                                                                                                                             +
                                           | BEGIN                                                                                                                                                                                                                                                                                                                                                                    +
                                           |     -- PASO 1: Desactivar condición anterior (marcar como histórica)                                                                                                                                                                                                                                                                                                     +
                                           |     UPDATE condiciones_diente                                                                                                                                                                                                                                                                                                                                            +
                                           |     SET activo = FALSE,                                                                                                                                                                                                                                                                                                                                                  +
                                           |         updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                   +
                                           |     WHERE paciente_id = p_paciente_id                                                                                                                                                                                                                                                                                                                                    +
                                           |       AND diente_numero = p_diente_numero                                                                                                                                                                                                                                                                                                                                +
                                           |       AND superficie = p_superficie                                                                                                                                                                                                                                                                                                                                      +
                                           |       AND activo = TRUE;                                                                                                                                                                                                                                                                                                                                                 +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     -- PASO 2: Insertar nueva condición como activa                                                                                                                                                                                                                                                                                                                      +
                                           |     INSERT INTO condiciones_diente (                                                                                                                                                                                                                                                                                                                                     +
                                           |         paciente_id,                                                                                                                                                                                                                                                                                                                                                     +
                                           |         diente_numero,                                                                                                                                                                                                                                                                                                                                                   +
                                           |         superficie,                                                                                                                                                                                                                                                                                                                                                      +
                                           |         tipo_condicion,                                                                                                                                                                                                                                                                                                                                                  +
                                           |         material_utilizado,                                                                                                                                                                                                                                                                                                                                              +
                                           |         descripcion,                                                                                                                                                                                                                                                                                                                                                     +
                                           |         intervencion_id,                                                                                                                                                                                                                                                                                                                                                 +
                                           |         registrado_por,                                                                                                                                                                                                                                                                                                                                                  +
                                           |         activo                                                                                                                                                                                                                                                                                                                                                           +
                                           |     ) VALUES (                                                                                                                                                                                                                                                                                                                                                           +
                                           |         p_paciente_id,                                                                                                                                                                                                                                                                                                                                                   +
                                           |         p_diente_numero,                                                                                                                                                                                                                                                                                                                                                 +
                                           |         p_superficie,                                                                                                                                                                                                                                                                                                                                                    +
                                           |         p_nueva_condicion,                                                                                                                                                                                                                                                                                                                                               +
                                           |         p_material,                                                                                                                                                                                                                                                                                                                                                      +
                                           |         p_descripcion,                                                                                                                                                                                                                                                                                                                                                   +
                                           |         p_intervencion_id,                                                                                                                                                                                                                                                                                                                                               +
                                           |         p_registrado_por,                                                                                                                                                                                                                                                                                                                                                +
                                           |         TRUE                                                                                                                                                                                                                                                                                                                                                             +
                                           |     ) RETURNING id INTO nueva_condicion_id;                                                                                                                                                                                                                                                                                                                              +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     RETURN nueva_condicion_id;                                                                                                                                                                                                                                                                                                                                           +
                                           | END;                                                                                                                                                                                                                                                                                                                                                                     +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 actualizar_condiciones_batch              | CREATE OR REPLACE FUNCTION public.actualizar_condiciones_batch(actualizaciones jsonb)                                                                                                                                                                                                                                                                                    +
                                           |  RETURNS jsonb                                                                                                                                                                                                                                                                                                                                                           +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$                                                                                                                                                                                                                                                                                                                                                            +
                                           | DECLARE                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     upd jsonb;                                                                                                                                                                                                                                                                                                                                                           +
                                           |     exitosos int := 0;                                                                                                                                                                                                                                                                                                                                                   +
                                           |     fallidos int := 0;                                                                                                                                                                                                                                                                                                                                                   +
                                           |     ids_creados text[] := '{}';                                                                                                                                                                                                                                                                                                                                          +
                                           |     nueva_condicion_id uuid;                                                                                                                                                                                                                                                                                                                                             +
                                           |     total_actualizaciones int;                                                                                                                                                                                                                                                                                                                                           +
                                           |     error_msg text;                                                                                                                                                                                                                                                                                                                                                      +
                                           | BEGIN                                                                                                                                                                                                                                                                                                                                                                    +
                                           |     -- Contar total de actualizaciones                                                                                                                                                                                                                                                                                                                                   +
                                           |     total_actualizaciones := jsonb_array_length(actualizaciones);                                                                                                                                                                                                                                                                                                        +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     RAISE NOTICE 'V4.0 Iniciando batch transaccional | Total: %', total_actualizaciones;                                                                                                                                                                                                                                                                                 +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     BEGIN                                                                                                                                                                                                                                                                                                                                                                +
                                           |         -- Iterar cada actualización                                                                                                                                                                                                                                                                                                                                     +
                                           |         FOR upd IN SELECT * FROM jsonb_array_elements(actualizaciones) LOOP                                                                                                                                                                                                                                                                                              +
                                           |             BEGIN                                                                                                                                                                                                                                                                                                                                                        +
                                           |                 -- Validar campos requeridos                                                                                                                                                                                                                                                                                                                             +
                                           |                 IF (upd->>'paciente_id') IS NULL OR                                                                                                                                                                                                                                                                                                                      +
                                           |                    (upd->>'diente_numero') IS NULL OR                                                                                                                                                                                                                                                                                                                    +
                                           |                    (upd->>'superficie') IS NULL OR                                                                                                                                                                                                                                                                                                                       +
                                           |                    (upd->>'tipo_condicion') IS NULL THEN                                                                                                                                                                                                                                                                                                                 +
                                           |                     RAISE WARNING 'Actualización inválida (campos NULL): %', upd;                                                                                                                                                                                                                                                                                        +
                                           |                     fallidos := fallidos + 1;                                                                                                                                                                                                                                                                                                                            +
                                           |                     CONTINUE;                                                                                                                                                                                                                                                                                                                                            +
                                           |                 END IF;                                                                                                                                                                                                                                                                                                                                                  +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |                 -- PASO A: Desactivar condición anterior (historial)                                                                                                                                                                                                                                                                                                     +
                                           |                 UPDATE condiciones_diente                                                                                                                                                                                                                                                                                                                                +
                                           |                 SET                                                                                                                                                                                                                                                                                                                                                      +
                                           |                     activo = FALSE,                                                                                                                                                                                                                                                                                                                                      +
                                           |                     updated_at = CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                       +
                                           |                 WHERE paciente_id = (upd->>'paciente_id')::uuid                                                                                                                                                                                                                                                                                                          +
                                           |                   AND diente_numero = (upd->>'diente_numero')::int                                                                                                                                                                                                                                                                                                       +
                                           |                   AND superficie = upd->>'superficie'                                                                                                                                                                                                                                                                                                                    +
                                           |                   AND activo = TRUE;                                                                                                                                                                                                                                                                                                                                     +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |                 -- PASO B: Insertar nueva condición (activa)                                                                                                                                                                                                                                                                                                             +
                                           |                 INSERT INTO condiciones_diente (                                                                                                                                                                                                                                                                                                                         +
                                           |                     paciente_id,                                                                                                                                                                                                                                                                                                                                         +
                                           |                     diente_numero,                                                                                                                                                                                                                                                                                                                                       +
                                           |                     superficie,                                                                                                                                                                                                                                                                                                                                          +
                                           |                     tipo_condicion,                                                                                                                                                                                                                                                                                                                                      +
                                           |                     material_utilizado,                                                                                                                                                                                                                                                                                                                                  +
                                           |                     descripcion,                                                                                                                                                                                                                                                                                                                                         +
                                           |                     intervencion_id,                                                                                                                                                                                                                                                                                                                                     +
                                           |                     registrado_por,                                                                                                                                                                                                                                                                                                                                      +
                                           |                     activo,                                                                                                                                                                                                                                                                                                                                              +
                                           |                     fecha_registro                                                                                                                                                                                                                                                                                                                                       +
                                           |                 ) VALUES (                                                                                                                                                                                                                                                                                                                                               +
                                           |                     (upd->>'paciente_id')::uuid,                                                                                                                                                                                                                                                                                                                         +
                                           |                     (upd->>'diente_numero')::int,                                                                                                                                                                                                                                                                                                                        +
                                           |                     upd->>'superficie',                                                                                                                                                                                                                                                                                                                                  +
                                           |                     upd->>'tipo_condicion',                                                                                                                                                                                                                                                                                                                              +
                                           |                     NULLIF(upd->>'material_utilizado', ''),                                                                                                                                                                                                                                                                                                              +
                                           |                     NULLIF(upd->>'descripcion', ''),                                                                                                                                                                                                                                                                                                                     +
                                           |                     (upd->>'intervencion_id')::uuid,                                                                                                                                                                                                                                                                                                                     +
                                           |                     NULLIF((upd->>'registrado_por'), '')::uuid,                                                                                                                                                                                                                                                                                                          +
                                           |                     TRUE,                                                                                                                                                                                                                                                                                                                                                +
                                           |                     CURRENT_TIMESTAMP                                                                                                                                                                                                                                                                                                                                    +
                                           |                 ) RETURNING id INTO nueva_condicion_id;                                                                                                                                                                                                                                                                                                                  +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |                 -- Registrar éxito                                                                                                                                                                                                                                                                                                                                       +
                                           |                 ids_creados := array_append(ids_creados, nueva_condicion_id::text);                                                                                                                                                                                                                                                                                      +
                                           |                 exitosos := exitosos + 1;                                                                                                                                                                                                                                                                                                                                +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |             EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                   +
                                           |                 -- Capturar error individual sin abortar batch completo                                                                                                                                                                                                                                                                                                  +
                                           |                 GET STACKED DIAGNOSTICS error_msg = MESSAGE_TEXT;                                                                                                                                                                                                                                                                                                        +
                                           |                 fallidos := fallidos + 1;                                                                                                                                                                                                                                                                                                                                +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |                 RAISE WARNING 'Error en actualización individual | Diente: % | Superficie: % | Error: %',                                                                                                                                                                                                                                                                +
                                           |                     upd->>'diente_numero',                                                                                                                                                                                                                                                                                                                               +
                                           |                     upd->>'superficie',                                                                                                                                                                                                                                                                                                                                  +
                                           |                     error_msg;                                                                                                                                                                                                                                                                                                                                           +
                                           |             END;                                                                                                                                                                                                                                                                                                                                                         +
                                           |         END LOOP;                                                                                                                                                                                                                                                                                                                                                        +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |         -- Validar resultado                                                                                                                                                                                                                                                                                                                                             +
                                           |         IF fallidos > 0 THEN                                                                                                                                                                                                                                                                                                                                             +
                                           |             RAISE WARNING 'Batch con fallos parciales | Exitosos: % | Fallidos: % | Total: %',                                                                                                                                                                                                                                                                           +
                                           |                 exitosos, fallidos, total_actualizaciones;                                                                                                                                                                                                                                                                                                               +
                                           |         END IF;                                                                                                                                                                                                                                                                                                                                                          +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |         RAISE NOTICE 'Batch completado | Exitosos: % | Fallidos: %',                                                                                                                                                                                                                                                                                                     +
                                           |             exitosos, fallidos;                                                                                                                                                                                                                                                                                                                                          +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     EXCEPTION WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                           +
                                           |         -- ROLLBACK automático en caso de error crítico                                                                                                                                                                                                                                                                                                                  +
                                           |         GET STACKED DIAGNOSTICS error_msg = MESSAGE_TEXT;                                                                                                                                                                                                                                                                                                                +
                                           |         RAISE WARNING 'Error crítico en batch, ROLLBACK automático: %', error_msg;                                                                                                                                                                                                                                                                                       +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |         -- Retornar todo como fallido                                                                                                                                                                                                                                                                                                                                    +
                                           |         exitosos := 0;                                                                                                                                                                                                                                                                                                                                                   +
                                           |         fallidos := total_actualizaciones;                                                                                                                                                                                                                                                                                                                               +
                                           |         ids_creados := '{}';                                                                                                                                                                                                                                                                                                                                             +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |         -- Re-lanzar para que llamador sepa que falló                                                                                                                                                                                                                                                                                                                    +
                                           |         RAISE;                                                                                                                                                                                                                                                                                                                                                           +
                                           |     END;                                                                                                                                                                                                                                                                                                                                                                 +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     -- Retornar resultado                                                                                                                                                                                                                                                                                                                                                +
                                           |     RETURN jsonb_build_object(                                                                                                                                                                                                                                                                                                                                           +
                                           |         'exitosos', exitosos,                                                                                                                                                                                                                                                                                                                                            +
                                           |         'fallidos', fallidos,                                                                                                                                                                                                                                                                                                                                            +
                                           |         'ids_creados', ids_creados,                                                                                                                                                                                                                                                                                                                                      +
                                           |         'total', total_actualizaciones,                                                                                                                                                                                                                                                                                                                                  +
                                           |         'tasa_exito_pct', ROUND((exitosos::decimal / NULLIF(total_actualizaciones, 0) * 100), 1)                                                                                                                                                                                                                                                                         +
                                           |     );                                                                                                                                                                                                                                                                                                                                                                   +
                                           | END;                                                                                                                                                                                                                                                                                                                                                                     +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 actualizar_costos_consulta                | CREATE OR REPLACE FUNCTION public.actualizar_costos_consulta()                                                                                                                                                                                                                                                                                                           +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | DECLARE\r                                                                                                                                                                                                                                                                                                                                                                +
                                           |     costo_bs_calc DECIMAL(10,2) := 0;\r                                                                                                                                                                                                                                                                                                                                  +
                                           |     costo_usd_calc DECIMAL(10,2) := 0;\r                                                                                                                                                                                                                                                                                                                                 +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     -- Calcular costos totales de todas las intervenciones de esta consulta\r                                                                                                                                                                                                                                                                                            +
                                           |     SELECT \r                                                                                                                                                                                                                                                                                                                                                            +
                                           |         COALESCE(SUM(total_bs), 0),\r                                                                                                                                                                                                                                                                                                                                    +
                                           |         COALESCE(SUM(total_usd), 0)\r                                                                                                                                                                                                                                                                                                                                    +
                                           |     INTO costo_bs_calc, costo_usd_calc\r                                                                                                                                                                                                                                                                                                                                 +
                                           |     FROM intervenciones \r                                                                                                                                                                                                                                                                                                                                               +
                                           |     WHERE consulta_id = COALESCE(NEW.consulta_id, OLD.consulta_id);\r                                                                                                                                                                                                                                                                                                    +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     -- Actualizar costos en la consulta\r                                                                                                                                                                                                                                                                                                                                +
                                           |     UPDATE consultas \r                                                                                                                                                                                                                                                                                                                                                  +
                                           |     SET \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         costo_total_bs = costo_bs_calc,\r                                                                                                                                                                                                                                                                                                                                +
                                           |         costo_total_usd = costo_usd_calc\r                                                                                                                                                                                                                                                                                                                               +
                                           |     WHERE id = COALESCE(NEW.consulta_id, OLD.consulta_id);\r                                                                                                                                                                                                                                                                                                             +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN COALESCE(NEW, OLD);\r                                                                                                                                                                                                                                                                                                                                         +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 actualizar_fecha_modificacion             | CREATE OR REPLACE FUNCTION public.actualizar_fecha_modificacion()                                                                                                                                                                                                                                                                                                        +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     NEW.fecha_actualizacion = CURRENT_TIMESTAMP;\r                                                                                                                                                                                                                                                                                                                       +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 asignar_orden_llegada                     | CREATE OR REPLACE FUNCTION public.asignar_orden_llegada()                                                                                                                                                                                                                                                                                                                +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | DECLARE\r                                                                                                                                                                                                                                                                                                                                                                +
                                           |     ultimo_orden_general INTEGER;\r                                                                                                                                                                                                                                                                                                                                      +
                                           |     ultimo_orden_odontologo INTEGER;\r                                                                                                                                                                                                                                                                                                                                   +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     -- Asignar orden general del día\r                                                                                                                                                                                                                                                                                                                                   +
                                           |     SELECT COALESCE(MAX(orden_llegada_general), 0) + 1\r                                                                                                                                                                                                                                                                                                                 +
                                           |     INTO ultimo_orden_general\r                                                                                                                                                                                                                                                                                                                                          +
                                           |     FROM consultas\r                                                                                                                                                                                                                                                                                                                                                     +
                                           |     WHERE DATE(fecha_llegada) = DATE(NEW.fecha_llegada);\r                                                                                                                                                                                                                                                                                                               +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     NEW.orden_llegada_general := ultimo_orden_general;\r                                                                                                                                                                                                                                                                                                                 +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     -- Asignar orden en cola del odontólogo\r                                                                                                                                                                                                                                                                                                                            +
                                           |     SELECT COALESCE(MAX(orden_cola_odontologo), 0) + 1\r                                                                                                                                                                                                                                                                                                                 +
                                           |     INTO ultimo_orden_odontologo\r                                                                                                                                                                                                                                                                                                                                       +
                                           |     FROM consultas\r                                                                                                                                                                                                                                                                                                                                                     +
                                           |     WHERE primer_odontologo_id = NEW.primer_odontologo_id\r                                                                                                                                                                                                                                                                                                              +
                                           |     AND DATE(fecha_llegada) = DATE(NEW.fecha_llegada)\r                                                                                                                                                                                                                                                                                                                  +
                                           |     AND estado IN ('en_espera', 'en_atencion');\r                                                                                                                                                                                                                                                                                                                        +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     NEW.orden_cola_odontologo := ultimo_orden_odontologo;\r                                                                                                                                                                                                                                                                                                              +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 calcular_edad_paciente                    | CREATE OR REPLACE FUNCTION public.calcular_edad_paciente()                                                                                                                                                                                                                                                                                                               +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     IF NEW.fecha_nacimiento IS NOT NULL THEN\r                                                                                                                                                                                                                                                                                                                           +
                                           |         NEW.edad = EXTRACT(YEAR FROM AGE(NEW.fecha_nacimiento));\r                                                                                                                                                                                                                                                                                                       +
                                           |     END IF;\r                                                                                                                                                                                                                                                                                                                                                            +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 calcular_saldos_pago                      | CREATE OR REPLACE FUNCTION public.calcular_saldos_pago()                                                                                                                                                                                                                                                                                                                 +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     NEW.saldo_pendiente_bs = NEW.monto_total_bs - NEW.monto_pagado_bs;\r                                                                                                                                                                                                                                                                                                 +
                                           |     NEW.saldo_pendiente_usd = NEW.monto_total_usd - NEW.monto_pagado_usd;\r                                                                                                                                                                                                                                                                                              +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 calcular_totales_intervencion             | CREATE OR REPLACE FUNCTION public.calcular_totales_intervencion()                                                                                                                                                                                                                                                                                                        +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | DECLARE\r                                                                                                                                                                                                                                                                                                                                                                +
                                           |     total_bs_calc DECIMAL(10,2) := 0;\r                                                                                                                                                                                                                                                                                                                                  +
                                           |     total_usd_calc DECIMAL(10,2) := 0;\r                                                                                                                                                                                                                                                                                                                                 +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     -- Calcular totales de servicios para esta intervención\r                                                                                                                                                                                                                                                                                                            +
                                           |     SELECT \r                                                                                                                                                                                                                                                                                                                                                            +
                                           |         COALESCE(SUM(precio_total_bs), 0),\r                                                                                                                                                                                                                                                                                                                             +
                                           |         COALESCE(SUM(precio_total_usd), 0)\r                                                                                                                                                                                                                                                                                                                             +
                                           |     INTO total_bs_calc, total_usd_calc\r                                                                                                                                                                                                                                                                                                                                 +
                                           |     FROM intervenciones_servicios \r                                                                                                                                                                                                                                                                                                                                     +
                                           |     WHERE intervencion_id = COALESCE(NEW.intervencion_id, OLD.intervencion_id);\r                                                                                                                                                                                                                                                                                        +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     -- Actualizar totales en la intervención\r                                                                                                                                                                                                                                                                                                                           +
                                           |     UPDATE intervenciones \r                                                                                                                                                                                                                                                                                                                                             +
                                           |     SET \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         total_bs = total_bs_calc - COALESCE(descuento_bs, 0),\r                                                                                                                                                                                                                                                                                                          +
                                           |         total_usd = total_usd_calc - COALESCE(descuento_usd, 0)\r                                                                                                                                                                                                                                                                                                        +
                                           |     WHERE id = COALESCE(NEW.intervencion_id, OLD.intervencion_id);\r                                                                                                                                                                                                                                                                                                     +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN COALESCE(NEW, OLD);\r                                                                                                                                                                                                                                                                                                                                         +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 cambiar_odontologo_consulta               | CREATE OR REPLACE FUNCTION public.cambiar_odontologo_consulta(consulta_id_param uuid, nuevo_odontologo_id uuid, motivo text DEFAULT NULL::text)                                                                                                                                                                                                                          +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | DECLARE\r                                                                                                                                                                                                                                                                                                                                                                +
                                           |     ultimo_orden INTEGER;\r                                                                                                                                                                                                                                                                                                                                              +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     -- Obtener último orden en cola del nuevo odontólogo\r                                                                                                                                                                                                                                                                                                               +
                                           |     SELECT COALESCE(MAX(orden_cola_odontologo), 0) + 1\r                                                                                                                                                                                                                                                                                                                 +
                                           |     INTO ultimo_orden\r                                                                                                                                                                                                                                                                                                                                                  +
                                           |     FROM consultas\r                                                                                                                                                                                                                                                                                                                                                     +
                                           |     WHERE primer_odontologo_id = nuevo_odontologo_id\r                                                                                                                                                                                                                                                                                                                   +
                                           |     AND DATE(fecha_llegada) = CURRENT_DATE\r                                                                                                                                                                                                                                                                                                                             +
                                           |     AND estado IN ('en_espera', 'en_atencion');\r                                                                                                                                                                                                                                                                                                                        +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     -- Actualizar la consulta\r                                                                                                                                                                                                                                                                                                                                          +
                                           |     UPDATE consultas\r                                                                                                                                                                                                                                                                                                                                                   +
                                           |     SET \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         primer_odontologo_id = nuevo_odontologo_id,\r                                                                                                                                                                                                                                                                                                                    +
                                           |         orden_cola_odontologo = ultimo_orden,\r                                                                                                                                                                                                                                                                                                                          +
                                           |         observaciones = COALESCE(observaciones, '') || \r                                                                                                                                                                                                                                                                                                                +
                                           |             CASE WHEN observaciones IS NOT NULL THEN E'\n' ELSE '' END ||\r                                                                                                                                                                                                                                                                                              +
                                           |             'Cambiado de odontólogo: ' || COALESCE(motivo, 'Sin motivo especificado') || ' - ' || CURRENT_TIMESTAMP\r                                                                                                                                                                                                                                                    +
                                           |     WHERE id = consulta_id_param;\r                                                                                                                                                                                                                                                                                                                                      +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN FOUND;\r                                                                                                                                                                                                                                                                                                                                                      +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 crear_odontograma_inicial                 | CREATE OR REPLACE FUNCTION public.crear_odontograma_inicial()                                                                                                                                                                                                                                                                                                            +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$                                                                                                                                                                                                                                                                                                                                                            +
                                           | DECLARE                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     diente INTEGER;                                                                                                                                                                                                                                                                                                                                                      +
                                           |     superficie TEXT;                                                                                                                                                                                                                                                                                                                                                     +
                                           |     total_creadas INTEGER := 0;                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN                                                                                                                                                                                                                                                                                                                                                                    +
                                           |     RAISE NOTICE 'Creando odontograma inicial para paciente %', NEW.numero_historia;                                                                                                                                                                                                                                                                                     +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     -- Crear 32 dientes × 5 superficies = 160 condiciones "sano"                                                                                                                                                                                                                                                                                                         +
                                           |     FOR diente IN                                                                                                                                                                                                                                                                                                                                                        +
                                           |         -- Cuadrante 1 (Superior Derecho): 18-11                                                                                                                                                                                                                                                                                                                         +
                                           |         SELECT unnest(ARRAY[18, 17, 16, 15, 14, 13, 12, 11])                                                                                                                                                                                                                                                                                                             +
                                           |         UNION ALL                                                                                                                                                                                                                                                                                                                                                        +
                                           |         -- Cuadrante 2 (Superior Izquierdo): 21-28                                                                                                                                                                                                                                                                                                                       +
                                           |         SELECT unnest(ARRAY[21, 22, 23, 24, 25, 26, 27, 28])                                                                                                                                                                                                                                                                                                             +
                                           |         UNION ALL                                                                                                                                                                                                                                                                                                                                                        +
                                           |         -- Cuadrante 3 (Inferior Izquierdo): 31-38                                                                                                                                                                                                                                                                                                                       +
                                           |         SELECT unnest(ARRAY[31, 32, 33, 34, 35, 36, 37, 38])                                                                                                                                                                                                                                                                                                             +
                                           |         UNION ALL                                                                                                                                                                                                                                                                                                                                                        +
                                           |         -- Cuadrante 4 (Inferior Derecho): 41-48                                                                                                                                                                                                                                                                                                                         +
                                           |         SELECT unnest(ARRAY[41, 42, 43, 44, 45, 46, 47, 48])                                                                                                                                                                                                                                                                                                             +
                                           |     LOOP                                                                                                                                                                                                                                                                                                                                                                 +
                                           |         FOR superficie IN SELECT unnest(ARRAY['oclusal', 'mesial', 'distal', 'vestibular', 'lingual'])                                                                                                                                                                                                                                                                   +
                                           |         LOOP                                                                                                                                                                                                                                                                                                                                                             +
                                           |             INSERT INTO condiciones_diente (                                                                                                                                                                                                                                                                                                                             +
                                           |                 paciente_id,                                                                                                                                                                                                                                                                                                                                             +
                                           |                 diente_numero,                                                                                                                                                                                                                                                                                                                                           +
                                           |                 superficie,                                                                                                                                                                                                                                                                                                                                              +
                                           |                 tipo_condicion,                                                                                                                                                                                                                                                                                                                                          +
                                           |                 severidad,                                                                                                                                                                                                                                                                                                                                               +
                                           |                 descripcion,                                                                                                                                                                                                                                                                                                                                             +
                                           |                 color_hex,                                                                                                                                                                                                                                                                                                                                               +
                                           |                 activo                                                                                                                                                                                                                                                                                                                                                   +
                                           |             ) VALUES (                                                                                                                                                                                                                                                                                                                                                   +
                                           |                 NEW.id,                                                                                                                                                                                                                                                                                                                                                  +
                                           |                 diente,                                                                                                                                                                                                                                                                                                                                                  +
                                           |                 superficie,                                                                                                                                                                                                                                                                                                                                              +
                                           |                 'sano',                                                                                                                                                                                                                                                                                                                                                  +
                                           |                 'leve',                                                                                                                                                                                                                                                                                                                                                  +
                                           |                 'Condición inicial',                                                                                                                                                                                                                                                                                                                                     +
                                           |                 '#90EE90',                                                                                                                                                                                                                                                                                                                                               +
                                           |                 TRUE                                                                                                                                                                                                                                                                                                                                                     +
                                           |             );                                                                                                                                                                                                                                                                                                                                                           +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |             total_creadas := total_creadas + 1;                                                                                                                                                                                                                                                                                                                          +
                                           |         END LOOP;                                                                                                                                                                                                                                                                                                                                                        +
                                           |     END LOOP;                                                                                                                                                                                                                                                                                                                                                            +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     RAISE NOTICE 'Odontograma inicial creado: % condiciones', total_creadas;                                                                                                                                                                                                                                                                                             +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                          +
                                           | END;                                                                                                                                                                                                                                                                                                                                                                     +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 generar_numero_consulta                   | CREATE OR REPLACE FUNCTION public.generar_numero_consulta()                                                                                                                                                                                                                                                                                                              +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | DECLARE\r                                                                                                                                                                                                                                                                                                                                                                +
                                           |     ultimo_numero INTEGER;\r                                                                                                                                                                                                                                                                                                                                             +
                                           |     nuevo_numero VARCHAR(20);\r                                                                                                                                                                                                                                                                                                                                          +
                                           |     fecha_actual DATE;\r                                                                                                                                                                                                                                                                                                                                                 +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     IF NEW.numero_consulta IS NULL OR NEW.numero_consulta = '' THEN\r                                                                                                                                                                                                                                                                                                    +
                                           |         fecha_actual := CURRENT_DATE;\r                                                                                                                                                                                                                                                                                                                                  +
                                           |         \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         SELECT COALESCE(MAX(CAST(SUBSTRING(numero_consulta FROM 10) AS INTEGER)), 0) + 1\r                                                                                                                                                                                                                                                                               +
                                           |         INTO ultimo_numero\r                                                                                                                                                                                                                                                                                                                                             +
                                           |         FROM consultas\r                                                                                                                                                                                                                                                                                                                                                 +
                                           |         WHERE numero_consulta ~ ('^' || TO_CHAR(fecha_actual, 'YYYYMMDD') || '[0-9]+$');\r                                                                                                                                                                                                                                                                               +
                                           |         \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         nuevo_numero := TO_CHAR(fecha_actual, 'YYYYMMDD') || LPAD(ultimo_numero::TEXT, 3, '0');\r                                                                                                                                                                                                                                                                        +
                                           |         NEW.numero_consulta := nuevo_numero;\r                                                                                                                                                                                                                                                                                                                           +
                                           |     END IF;\r                                                                                                                                                                                                                                                                                                                                                            +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 generar_numero_historia                   | CREATE OR REPLACE FUNCTION public.generar_numero_historia()                                                                                                                                                                                                                                                                                                              +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | DECLARE\r                                                                                                                                                                                                                                                                                                                                                                +
                                           |     ultimo_numero INTEGER;\r                                                                                                                                                                                                                                                                                                                                             +
                                           |     nuevo_numero VARCHAR(20);\r                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     IF NEW.numero_historia IS NULL OR NEW.numero_historia = '' THEN\r                                                                                                                                                                                                                                                                                                    +
                                           |         SELECT COALESCE(MAX(CAST(SUBSTRING(numero_historia FROM 3) AS INTEGER)), 0) + 1\r                                                                                                                                                                                                                                                                                +
                                           |         INTO ultimo_numero\r                                                                                                                                                                                                                                                                                                                                             +
                                           |         FROM pacientes\r                                                                                                                                                                                                                                                                                                                                                 +
                                           |         WHERE numero_historia ~ '^HC[0-9]+$';\r                                                                                                                                                                                                                                                                                                                          +
                                           |         \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         nuevo_numero := 'HC' || LPAD(ultimo_numero::TEXT, 6, '0');\r                                                                                                                                                                                                                                                                                                     +
                                           |         NEW.numero_historia := nuevo_numero;\r                                                                                                                                                                                                                                                                                                                           +
                                           |     END IF;\r                                                                                                                                                                                                                                                                                                                                                            +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 generar_numero_recibo                     | CREATE OR REPLACE FUNCTION public.generar_numero_recibo()                                                                                                                                                                                                                                                                                                                +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$                                                                                                                                                                                                                                                                                                                                                            +
                                           | DECLARE                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     ultimo_numero INTEGER;                                                                                                                                                                                                                                                                                                                                               +
                                           |     nuevo_numero VARCHAR(20);                                                                                                                                                                                                                                                                                                                                            +
                                           |     fecha_actual DATE;                                                                                                                                                                                                                                                                                                                                                   +
                                           |     prefijo TEXT;                                                                                                                                                                                                                                                                                                                                                        +
                                           | BEGIN                                                                                                                                                                                                                                                                                                                                                                    +
                                           |     IF NEW.numero_recibo IS NULL OR NEW.numero_recibo = '' THEN                                                                                                                                                                                                                                                                                                          +
                                           |         fecha_actual := COALESCE(NEW.fecha_pago::DATE, CURRENT_DATE);                                                                                                                                                                                                                                                                                                    +
                                           |         prefijo := 'REC' || TO_CHAR(fecha_actual, 'YYYYMM');                                                                                                                                                                                                                                                                                                             +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |         SELECT COALESCE(MAX(CAST(SUBSTRING(numero_recibo FROM 12) AS INTEGER)), 0) + 1                                                                                                                                                                                                                                                                                   +
                                           |         INTO ultimo_numero                                                                                                                                                                                                                                                                                                                                               +
                                           |         FROM pagos                                                                                                                                                                                                                                                                                                                                                       +
                                           |         WHERE numero_recibo LIKE prefijo || '%';                                                                                                                                                                                                                                                                                                                         +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |         nuevo_numero := prefijo || LPAD(ultimo_numero::TEXT, 4, '0');                                                                                                                                                                                                                                                                                                    +
                                           |         NEW.numero_recibo := nuevo_numero;                                                                                                                                                                                                                                                                                                                               +
                                           |     END IF;                                                                                                                                                                                                                                                                                                                                                              +
                                           |                                                                                                                                                                                                                                                                                                                                                                          +
                                           |     RETURN NEW;                                                                                                                                                                                                                                                                                                                                                          +
                                           | END;                                                                                                                                                                                                                                                                                                                                                                     +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 gin_extract_query_trgm                    | CREATE OR REPLACE FUNCTION public.gin_extract_query_trgm(text, internal, smallint, internal, internal, internal, internal)                                                                                                                                                                                                                                               +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gin_extract_query_trgm$function$                                                                                                                                                                                                                                                                                                         +
                                           | 
 gin_extract_value_trgm                    | CREATE OR REPLACE FUNCTION public.gin_extract_value_trgm(text, internal)                                                                                                                                                                                                                                                                                                 +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gin_extract_value_trgm$function$                                                                                                                                                                                                                                                                                                         +
                                           | 
 gin_trgm_consistent                       | CREATE OR REPLACE FUNCTION public.gin_trgm_consistent(internal, smallint, text, integer, internal, internal, internal, internal)                                                                                                                                                                                                                                         +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gin_trgm_consistent$function$                                                                                                                                                                                                                                                                                                            +
                                           | 
 gin_trgm_triconsistent                    | CREATE OR REPLACE FUNCTION public.gin_trgm_triconsistent(internal, smallint, text, integer, internal, internal, internal)                                                                                                                                                                                                                                                +
                                           |  RETURNS "char"                                                                                                                                                                                                                                                                                                                                                          +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gin_trgm_triconsistent$function$                                                                                                                                                                                                                                                                                                         +
                                           | 
 gtrgm_compress                            | CREATE OR REPLACE FUNCTION public.gtrgm_compress(internal)                                                                                                                                                                                                                                                                                                               +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_compress$function$                                                                                                                                                                                                                                                                                                                 +
                                           | 
 gtrgm_consistent                          | CREATE OR REPLACE FUNCTION public.gtrgm_consistent(internal, text, smallint, oid, internal)                                                                                                                                                                                                                                                                              +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_consistent$function$                                                                                                                                                                                                                                                                                                               +
                                           | 
 gtrgm_decompress                          | CREATE OR REPLACE FUNCTION public.gtrgm_decompress(internal)                                                                                                                                                                                                                                                                                                             +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_decompress$function$                                                                                                                                                                                                                                                                                                               +
                                           | 
 gtrgm_distance                            | CREATE OR REPLACE FUNCTION public.gtrgm_distance(internal, text, smallint, oid, internal)                                                                                                                                                                                                                                                                                +
                                           |  RETURNS double precision                                                                                                                                                                                                                                                                                                                                                +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_distance$function$                                                                                                                                                                                                                                                                                                                 +
                                           | 
 gtrgm_in                                  | CREATE OR REPLACE FUNCTION public.gtrgm_in(cstring)                                                                                                                                                                                                                                                                                                                      +
                                           |  RETURNS gtrgm                                                                                                                                                                                                                                                                                                                                                           +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_in$function$                                                                                                                                                                                                                                                                                                                       +
                                           | 
 gtrgm_options                             | CREATE OR REPLACE FUNCTION public.gtrgm_options(internal)                                                                                                                                                                                                                                                                                                                +
                                           |  RETURNS void                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE                                                                                                                                                                                                                                                                                                                                                 +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_options$function$                                                                                                                                                                                                                                                                                                                  +
                                           | 
 gtrgm_out                                 | CREATE OR REPLACE FUNCTION public.gtrgm_out(gtrgm)                                                                                                                                                                                                                                                                                                                       +
                                           |  RETURNS cstring                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_out$function$                                                                                                                                                                                                                                                                                                                      +
                                           | 
 gtrgm_penalty                             | CREATE OR REPLACE FUNCTION public.gtrgm_penalty(internal, internal, internal)                                                                                                                                                                                                                                                                                            +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_penalty$function$                                                                                                                                                                                                                                                                                                                  +
                                           | 
 gtrgm_picksplit                           | CREATE OR REPLACE FUNCTION public.gtrgm_picksplit(internal, internal)                                                                                                                                                                                                                                                                                                    +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_picksplit$function$                                                                                                                                                                                                                                                                                                                +
                                           | 
 gtrgm_same                                | CREATE OR REPLACE FUNCTION public.gtrgm_same(gtrgm, gtrgm, internal)                                                                                                                                                                                                                                                                                                     +
                                           |  RETURNS internal                                                                                                                                                                                                                                                                                                                                                        +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_same$function$                                                                                                                                                                                                                                                                                                                     +
                                           | 
 gtrgm_union                               | CREATE OR REPLACE FUNCTION public.gtrgm_union(internal, internal)                                                                                                                                                                                                                                                                                                        +
                                           |  RETURNS gtrgm                                                                                                                                                                                                                                                                                                                                                           +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$gtrgm_union$function$                                                                                                                                                                                                                                                                                                                    +
                                           | 
 manejar_version_odontograma               | CREATE OR REPLACE FUNCTION public.manejar_version_odontograma()                                                                                                                                                                                                                                                                                                          +
                                           |  RETURNS trigger                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     -- Si se está creando una nueva versión actual\r                                                                                                                                                                                                                                                                                                                     +
                                           |     IF NEW.es_version_actual = TRUE THEN\r                                                                                                                                                                                                                                                                                                                               +
                                           |         -- Marcar todas las otras versiones como no actuales\r                                                                                                                                                                                                                                                                                                           +
                                           |         UPDATE odontograma \r                                                                                                                                                                                                                                                                                                                                            +
                                           |         SET es_version_actual = FALSE \r                                                                                                                                                                                                                                                                                                                                 +
                                           |         WHERE paciente_id = NEW.paciente_id \r                                                                                                                                                                                                                                                                                                                           +
                                           |         AND id != NEW.id;\r                                                                                                                                                                                                                                                                                                                                              +
                                           |         \r                                                                                                                                                                                                                                                                                                                                                               +
                                           |         -- Si no es la primera versión, calcular estadísticas\r                                                                                                                                                                                                                                                                                                          +
                                           |         IF NEW.version > 1 THEN\r                                                                                                                                                                                                                                                                                                                                        +
                                           |             NEW.estadisticas_condiciones = (\r                                                                                                                                                                                                                                                                                                                           +
                                           |                 SELECT jsonb_build_object(\r                                                                                                                                                                                                                                                                                                                             +
                                           |                     'total_condiciones', COUNT(*),\r                                                                                                                                                                                                                                                                                                                     +
                                           |                     'condiciones_por_tipo', jsonb_object_agg(tipo_condicion, cantidad)\r                                                                                                                                                                                                                                                                                 +
                                           |                 )\r                                                                                                                                                                                                                                                                                                                                                      +
                                           |                 FROM (\r                                                                                                                                                                                                                                                                                                                                                 +
                                           |                     SELECT tipo_condicion, COUNT(*) as cantidad\r                                                                                                                                                                                                                                                                                                        +
                                           |                     FROM condiciones_diente \r                                                                                                                                                                                                                                                                                                                           +
                                           |                     WHERE odontograma_id = NEW.id\r                                                                                                                                                                                                                                                                                                                      +
                                           |                     GROUP BY tipo_condicion\r                                                                                                                                                                                                                                                                                                                            +
                                           |                 ) stats\r                                                                                                                                                                                                                                                                                                                                                +
                                           |             );\r                                                                                                                                                                                                                                                                                                                                                         +
                                           |         END IF;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           |     END IF;\r                                                                                                                                                                                                                                                                                                                                                            +
                                           |     \r                                                                                                                                                                                                                                                                                                                                                                   +
                                           |     RETURN NEW;\r                                                                                                                                                                                                                                                                                                                                                        +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 obtener_proximo_paciente                  | CREATE OR REPLACE FUNCTION public.obtener_proximo_paciente(odontologo_id_param uuid)                                                                                                                                                                                                                                                                                     +
                                           |  RETURNS TABLE(consulta_id uuid, paciente_nombre text, numero_historia character varying, orden_cola integer, tiempo_espera interval)                                                                                                                                                                                                                                    +
                                           |  LANGUAGE plpgsql                                                                                                                                                                                                                                                                                                                                                        +
                                           | AS $function$\r                                                                                                                                                                                                                                                                                                                                                          +
                                           | BEGIN\r                                                                                                                                                                                                                                                                                                                                                                  +
                                           |     RETURN QUERY\r                                                                                                                                                                                                                                                                                                                                                       +
                                           |     SELECT \r                                                                                                                                                                                                                                                                                                                                                            +
                                           |         c.id,\r                                                                                                                                                                                                                                                                                                                                                          +
                                           |         TRIM(CONCAT(p.primer_nombre, ' ', COALESCE(p.segundo_nombre, ''), ' ', p.primer_apellido, ' ', COALESCE(p.segundo_apellido, ''))),\r                                                                                                                                                                                                                             +
                                           |         p.numero_historia,\r                                                                                                                                                                                                                                                                                                                                             +
                                           |         c.orden_cola_odontologo,\r                                                                                                                                                                                                                                                                                                                                       +
                                           |         AGE(CURRENT_TIMESTAMP, c.fecha_llegada)\r                                                                                                                                                                                                                                                                                                                        +
                                           |     FROM consultas c\r                                                                                                                                                                                                                                                                                                                                                   +
                                           |     JOIN pacientes p ON c.paciente_id = p.id\r                                                                                                                                                                                                                                                                                                                           +
                                           |     WHERE c.primer_odontologo_id = odontologo_id_param\r                                                                                                                                                                                                                                                                                                                 +
                                           |     AND c.estado = 'en_espera'\r                                                                                                                                                                                                                                                                                                                                         +
                                           |     AND DATE(c.fecha_llegada) = CURRENT_DATE\r                                                                                                                                                                                                                                                                                                                           +
                                           |     ORDER BY c.orden_cola_odontologo\r                                                                                                                                                                                                                                                                                                                                   +
                                           |     LIMIT 1;\r                                                                                                                                                                                                                                                                                                                                                           +
                                           | END;\r                                                                                                                                                                                                                                                                                                                                                                   +
                                           | $function$                                                                                                                                                                                                                                                                                                                                                               +
                                           | 
 set_limit                                 | CREATE OR REPLACE FUNCTION public.set_limit(real)                                                                                                                                                                                                                                                                                                                        +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STRICT                                                                                                                                                                                                                                                                                                                                                                  +
                                           | AS '$libdir/pg_trgm', $function$set_limit$function$                                                                                                                                                                                                                                                                                                                      +
                                           | 
 show_limit                                | CREATE OR REPLACE FUNCTION public.show_limit()                                                                                                                                                                                                                                                                                                                           +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                             +
                                           | AS '$libdir/pg_trgm', $function$show_limit$function$                                                                                                                                                                                                                                                                                                                     +
                                           | 
 show_trgm                                 | CREATE OR REPLACE FUNCTION public.show_trgm(text)                                                                                                                                                                                                                                                                                                                        +
                                           |  RETURNS text[]                                                                                                                                                                                                                                                                                                                                                          +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$show_trgm$function$                                                                                                                                                                                                                                                                                                                      +
                                           | 
 similarity                                | CREATE OR REPLACE FUNCTION public.similarity(text, text)                                                                                                                                                                                                                                                                                                                 +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$similarity$function$                                                                                                                                                                                                                                                                                                                     +
                                           | 
 similarity_dist                           | CREATE OR REPLACE FUNCTION public.similarity_dist(text, text)                                                                                                                                                                                                                                                                                                            +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$similarity_dist$function$                                                                                                                                                                                                                                                                                                                +
                                           | 
 similarity_op                             | CREATE OR REPLACE FUNCTION public.similarity_op(text, text)                                                                                                                                                                                                                                                                                                              +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                             +
                                           | AS '$libdir/pg_trgm', $function$similarity_op$function$                                                                                                                                                                                                                                                                                                                  +
                                           | 
 strict_word_similarity                    | CREATE OR REPLACE FUNCTION public.strict_word_similarity(text, text)                                                                                                                                                                                                                                                                                                     +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$strict_word_similarity$function$                                                                                                                                                                                                                                                                                                         +
                                           | 
 strict_word_similarity_commutator_op      | CREATE OR REPLACE FUNCTION public.strict_word_similarity_commutator_op(text, text)                                                                                                                                                                                                                                                                                       +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                             +
                                           | AS '$libdir/pg_trgm', $function$strict_word_similarity_commutator_op$function$                                                                                                                                                                                                                                                                                           +
                                           | 
 strict_word_similarity_dist_commutator_op | CREATE OR REPLACE FUNCTION public.strict_word_similarity_dist_commutator_op(text, text)                                                                                                                                                                                                                                                                                  +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$strict_word_similarity_dist_commutator_op$function$                                                                                                                                                                                                                                                                                      +
                                           | 
 strict_word_similarity_dist_op            | CREATE OR REPLACE FUNCTION public.strict_word_similarity_dist_op(text, text)                                                                                                                                                                                                                                                                                             +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$strict_word_similarity_dist_op$function$                                                                                                                                                                                                                                                                                                 +
                                           | 
 strict_word_similarity_op                 | CREATE OR REPLACE FUNCTION public.strict_word_similarity_op(text, text)                                                                                                                                                                                                                                                                                                  +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                             +
                                           | AS '$libdir/pg_trgm', $function$strict_word_similarity_op$function$                                                                                                                                                                                                                                                                                                      +
                                           | 
 word_similarity                           | CREATE OR REPLACE FUNCTION public.word_similarity(text, text)                                                                                                                                                                                                                                                                                                            +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$word_similarity$function$                                                                                                                                                                                                                                                                                                                +
                                           | 
 word_similarity_commutator_op             | CREATE OR REPLACE FUNCTION public.word_similarity_commutator_op(text, text)                                                                                                                                                                                                                                                                                              +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                             +
                                           | AS '$libdir/pg_trgm', $function$word_similarity_commutator_op$function$                                                                                                                                                                                                                                                                                                  +
                                           | 
 word_similarity_dist_commutator_op        | CREATE OR REPLACE FUNCTION public.word_similarity_dist_commutator_op(text, text)                                                                                                                                                                                                                                                                                         +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$word_similarity_dist_commutator_op$function$                                                                                                                                                                                                                                                                                             +
                                           | 
 word_similarity_dist_op                   | CREATE OR REPLACE FUNCTION public.word_similarity_dist_op(text, text)                                                                                                                                                                                                                                                                                                    +
                                           |  RETURNS real                                                                                                                                                                                                                                                                                                                                                            +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  IMMUTABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                          +
                                           | AS '$libdir/pg_trgm', $function$word_similarity_dist_op$function$                                                                                                                                                                                                                                                                                                        +
                                           | 
 word_similarity_op                        | CREATE OR REPLACE FUNCTION public.word_similarity_op(text, text)                                                                                                                                                                                                                                                                                                         +
                                           |  RETURNS boolean                                                                                                                                                                                                                                                                                                                                                         +
                                           |  LANGUAGE c                                                                                                                                                                                                                                                                                                                                                              +
                                           |  STABLE PARALLEL SAFE STRICT                                                                                                                                                                                                                                                                                                                                             +
                                           | AS '$libdir/pg_trgm', $function$word_similarity_op$function$                                                                                                                                                                                                                                                                                                             +
                                           | 
(46 rows)

```
