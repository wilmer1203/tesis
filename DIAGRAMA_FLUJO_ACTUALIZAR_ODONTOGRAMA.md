# ğŸ¨ DIAGRAMA VISUAL: Flujo de ActualizaciÃ³n de Odontograma

**Archivo Principal:** `estado_intervencion_servicios.py::_actualizar_odontograma_por_servicios()`
**Fecha:** 2025-10-19

---

## ğŸ“Š VISTA GENERAL DEL FLUJO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  FUNCIÃ“N: _actualizar_odontograma_por_servicios()                     â”‚
â”‚                                                                        â”‚
â”‚  INPUT:                                                                â”‚
â”‚  - intervencion_id: "uuid-123"                                        â”‚
â”‚  - servicios: List[ServicioIntervencionCompleto | Dict | ...]        â”‚
â”‚                                                                        â”‚
â”‚  OUTPUT:                                                               â”‚
â”‚  - ActualizacionOdontogramaResult {                                   â”‚
â”‚      exitosos: 5,                                                     â”‚
â”‚      fallidos: 0,                                                     â”‚
â”‚      advertencias: ["..."],                                           â”‚
â”‚      ids_creados: ["uuid1", "uuid2", ...]                            â”‚
â”‚    }                                                                   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO DETALLADO PASO A PASO

### **PASO 1: VALIDACIÃ“N DE CONTEXTO**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” PASO 1: Validar Contexto                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Verificar:                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Â¿self.paciente_actual existe?         â”‚            â”‚
â”‚  â”‚ Â¿self.paciente_actual.id vÃ¡lido?      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                             â”‚
â”‚           â†“                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚    â”‚ NO (âŒ) â”‚ â†’ Advertencia + Return vacÃ­o            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚           â”‚                                             â”‚
â”‚           â†“ SÃ (âœ…)                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Â¿servicios no vacÃ­o?                  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                             â”‚
â”‚           â†“                                             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚    â”‚ NO (âŒ) â”‚ â†’ Advertencia + Return vacÃ­o            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚           â”‚                                             â”‚
â”‚           â†“ SÃ (âœ…)                                     â”‚
â”‚  Continuar a Paso 2                                    â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 2: NORMALIZACIÃ“N DE SERVICIOS**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”„ PASO 2: Normalizar Servicios                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  INPUT: servicios = [                                                â”‚
â”‚    ServicioIntervencionCompleto(...),  â† Formato 1                  â”‚
â”‚    {"nombre": "...", ...},              â† Formato 2 (dict)          â”‚
â”‚    ServicioIntervencionTemporal(...)    â† Formato 3 (DEPRECATED)   â”‚
â”‚  ]                                                                   â”‚
â”‚                                                                      â”‚
â”‚  PROCESO:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Para cada servicio en servicios:                   â”‚            â”‚
â”‚  â”‚   â”œâ”€ _normalizar_servicio(servicio)                â”‚            â”‚
â”‚  â”‚   â”œâ”€ Detectar tipo (isinstance checks)             â”‚            â”‚
â”‚  â”‚   â”œâ”€ Extraer campos estandarizados:                â”‚            â”‚
â”‚  â”‚   â”‚   - nombre                                      â”‚            â”‚
â”‚  â”‚   â”‚   - condicion_resultante                        â”‚            â”‚
â”‚  â”‚   â”‚   - diente_numero (Â¡solo primero!)             â”‚            â”‚
â”‚  â”‚   â”‚   - superficies (expandir "completa")          â”‚            â”‚
â”‚  â”‚   â”‚   - material                                    â”‚            â”‚
â”‚  â”‚   â”‚   - observaciones                               â”‚            â”‚
â”‚  â”‚   â””â”€ Retornar dict normalizado                     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                      â”‚
â”‚  OUTPUT: servicios_normalizados = [                                 â”‚
â”‚    {                                                                 â”‚
â”‚      "nombre": "ObturaciÃ³n Simple",                                 â”‚
â”‚      "condicion_resultante": "obturacion",                          â”‚
â”‚      "diente_numero": 11,                                           â”‚
â”‚      "superficies": ["oclusal", "mesial"],                          â”‚
â”‚      "material": "Resina",                                          â”‚
â”‚      "observaciones": "..."                                         â”‚
â”‚    },                                                                â”‚
â”‚    ...                                                               â”‚
â”‚  ]                                                                   â”‚
â”‚                                                                      â”‚
â”‚  âš ï¸ PROBLEMA: Si servicio afecta dientes [11,12,13],               â”‚
â”‚     solo toma 11, pierde 12 y 13                                    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 3: FILTRADO DE SERVICIOS ACTIVOS**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” PASO 3: Filtrar Servicios Activos                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  CRITERIO: Solo servicios que modifican odontograma              â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ servicios_activos = [                           â”‚           â”‚
â”‚  â”‚   s for s in servicios_normalizados             â”‚           â”‚
â”‚  â”‚   if s.get("condicion_resultante")  â† NO None   â”‚           â”‚
â”‚  â”‚   and s.get("diente_numero")        â† NO None   â”‚           â”‚
â”‚  â”‚ ]                                                â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â”‚  EJEMPLOS:                                                       â”‚
â”‚                                                                  â”‚
â”‚  âœ… INCLUIDOS (servicios activos):                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ ObturaciÃ³n â†’ diente 11              â”‚                       â”‚
â”‚  â”‚ Endodoncia â†’ diente 16              â”‚                       â”‚
â”‚  â”‚ ExtracciÃ³n â†’ diente 48              â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                  â”‚
â”‚  âŒ EXCLUIDOS (servicios preventivos/generales):                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ Consulta General â†’ sin diente       â”‚                       â”‚
â”‚  â”‚ Limpieza Dental â†’ preventiva        â”‚                       â”‚
â”‚  â”‚ AplicaciÃ³n FlÃºor â†’ preventiva       â”‚                       â”‚
â”‚  â”‚ RadiografÃ­a â†’ diagnÃ³stico           â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                  â”‚
â”‚  Â¿servicios_activos vacÃ­o?                                      â”‚
â”‚    â†“ SÃ â†’ Advertencia + Return                                  â”‚
â”‚    â†“ NO â†’ Continuar a Paso 4                                    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 4: RESOLUCIÃ“N DE CONFLICTOS**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš–ï¸ PASO 4: Resolver Conflictos por Prioridad                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  PROBLEMA: MÃºltiples servicios afectan mismo diente + superficie      â”‚
â”‚                                                                        â”‚
â”‚  EJEMPLO DE CONFLICTO:                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Servicio 1: "Caries"      â†’ Diente 11, oclusal        â”‚          â”‚
â”‚  â”‚ Servicio 2: "ObturaciÃ³n"  â†’ Diente 11, oclusal        â”‚          â”‚
â”‚  â”‚                                                        â”‚          â”‚
â”‚  â”‚ â“ Â¿CuÃ¡l aplicar?                                      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                        â”‚
â”‚  PROCESO:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ SUB-PASO 4.1: Cargar CatÃ¡logo Prioridades             â”‚          â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚
â”‚  â”‚ â”‚ Query BD:                                 â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ SELECT codigo, prioridad                  â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ FROM catalogo_condiciones                 â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ WHERE activo = TRUE                       â”‚          â”‚          â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â”‚
â”‚  â”‚                                                        â”‚          â”‚
â”‚  â”‚ Resultado:                                             â”‚          â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚
â”‚  â”‚ â”‚ ausente     â†’ prioridad 100               â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ caries      â†’ prioridad 90                â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ endodoncia  â†’ prioridad 85                â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ obturacion  â†’ prioridad 70                â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ sano        â†’ prioridad 10                â”‚          â”‚          â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ SUB-PASO 4.2: Agrupar por Diente + Superficie         â”‚          â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚
â”‚  â”‚ â”‚ grupos = {                                â”‚          â”‚          â”‚
â”‚  â”‚ â”‚   "11_oclusal": [servicio1, servicio2],   â”‚          â”‚          â”‚
â”‚  â”‚ â”‚   "11_mesial": [servicio3],               â”‚          â”‚          â”‚
â”‚  â”‚ â”‚   "16_oclusal": [servicio4]               â”‚          â”‚          â”‚
â”‚  â”‚ â”‚ }                                          â”‚          â”‚          â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ SUB-PASO 4.3: Resolver Cada Grupo                     â”‚          â”‚
â”‚  â”‚                                                        â”‚          â”‚
â”‚  â”‚ Para "11_oclusal": [caries(90), obturacion(70)]       â”‚          â”‚
â”‚  â”‚   â”œâ”€ Ordenar por prioridad DESC                       â”‚          â”‚
â”‚  â”‚   â”‚  â†’ [caries(90), obturacion(70)]                   â”‚          â”‚
â”‚  â”‚   â”œâ”€ Tomar primero (mayor prioridad)                  â”‚          â”‚
â”‚  â”‚   â”‚  â†’ caries                                          â”‚          â”‚
â”‚  â”‚   â””â”€ âš ï¸ PROBLEMA: Â¿Es correcto?                       â”‚          â”‚
â”‚  â”‚      Si se aplicÃ³ obturaciÃ³n, ya no hay caries        â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                        â”‚
â”‚  REGLAS ESPECIALES:                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Si condiciÃ³n == "ausente":                             â”‚          â”‚
â”‚  â”‚   â†’ SKIP (no se puede tratar diente ausente)          â”‚          â”‚
â”‚  â”‚                                                        â”‚          â”‚
â”‚  â”‚ Si misma prioridad:                                    â”‚          â”‚
â”‚  â”‚   â†’ Ãšltimo servicio gana                               â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                        â”‚
â”‚  OUTPUT: servicios_resueltos (sin conflictos)                         â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 5: PREPARACIÃ“N BATCH**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“¦ PASO 5: Preparar Actualizaciones Batch                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  OBJETIVO: Explotar servicios por superficie                         â”‚
â”‚                                                                      â”‚
â”‚  INPUT: servicios_resueltos = [                                      â”‚
â”‚    {                                                                 â”‚
â”‚      "diente_numero": 11,                                            â”‚
â”‚      "superficies": ["oclusal", "mesial"],  â† 2 superficies         â”‚
â”‚      "condicion_resultante": "obturacion",                           â”‚
â”‚      "material": "Resina",                                           â”‚
â”‚      "observaciones": "..."                                          â”‚
â”‚    }                                                                 â”‚
â”‚  ]                                                                   â”‚
â”‚                                                                      â”‚
â”‚  PROCESO:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ actualizaciones = []                               â”‚            â”‚
â”‚  â”‚                                                    â”‚            â”‚
â”‚  â”‚ Para cada servicio en servicios_resueltos:         â”‚            â”‚
â”‚  â”‚   Para cada superficie en servicio.superficies:    â”‚            â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚            â”‚
â”‚  â”‚     â”‚ Crear dict:                         â”‚       â”‚            â”‚
â”‚  â”‚     â”‚ {                                    â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "paciente_id": "uuid-pac",        â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "diente_numero": 11,              â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "superficie": "oclusal",  â† UNO   â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "tipo_condicion": "obturacion",   â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "material_utilizado": "Resina",   â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "descripcion": "...",             â”‚       â”‚            â”‚
â”‚  â”‚     â”‚   "intervencion_id": "uuid-interv"  â”‚       â”‚            â”‚
â”‚  â”‚     â”‚ }                                    â”‚       â”‚            â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚            â”‚
â”‚  â”‚     actualizaciones.append(dict)                   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                      â”‚
â”‚  OUTPUT: actualizaciones = [                                         â”‚
â”‚    {diente: 11, superficie: "oclusal", ...},   â† Registro 1         â”‚
â”‚    {diente: 11, superficie: "mesial", ...}     â† Registro 2         â”‚
â”‚  ]                                                                   â”‚
â”‚                                                                      â”‚
â”‚  âœ… VENTAJA: Granularidad perfecta (una condiciÃ³n por superficie)   â”‚
â”‚                                                                      â”‚
â”‚  Â¿actualizaciones vacÃ­o?                                             â”‚
â”‚    â†“ SÃ â†’ Advertencia + Return                                      â”‚
â”‚    â†“ NO â†’ Continuar a Paso 6                                        â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 6: EJECUCIÃ“N BATCH TRANSACCIONAL**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš€ PASO 6: Ejecutar Batch en Base de Datos                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  LLAMADA:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ batch_result = await odontologia_service             â”‚            â”‚
â”‚  â”‚   .actualizar_condiciones_batch(actualizaciones)     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                        â”‚
â”‚  FUNCIÃ“N SQL: actualizar_condiciones_batch(jsonb)                     â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ PostgreSQL Loop:                                               â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚ Para cada actualizaciÃ³n en actualizaciones:                    â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚   â”‚ PASO A: Desactivar condiciÃ³n anterior         â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ UPDATE condiciones_diente        â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ SET activo = FALSE               â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ WHERE paciente_id = ?            â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   AND diente_numero = ?          â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   AND superficie = ?             â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   AND activo = TRUE              â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚  â”‚
â”‚  â”‚   â”‚ PASO B: Insertar nueva condiciÃ³n              â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ INSERT INTO condiciones_diente   â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ (                                 â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   paciente_id,                    â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   diente_numero,                  â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   superficie,                     â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   tipo_condicion,                 â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   material_utilizado,             â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   descripcion,                    â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   intervencion_id,                â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚   activo = TRUE  â† NUEVA ACTIVA   â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ ) VALUES (...)                    â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â”‚ RETURNING id                      â”‚          â”‚          â”‚  â”‚
â”‚  â”‚   â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚   Si Ã©xito: exitosos++, ids_creados.append(id)                 â”‚  â”‚
â”‚  â”‚   Si error: fallidos++                                         â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  âš ï¸ PROBLEMA: NO hay transacciÃ³n explÃ­cita                            â”‚
â”‚     Si falla actualizaciÃ³n #5 de 10, las primeras 4 persisten         â”‚
â”‚                                                                        â”‚
â”‚  RETORNO:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ {                                                    â”‚            â”‚
â”‚  â”‚   "exitosos": 5,                                     â”‚            â”‚
â”‚  â”‚   "fallidos": 0,                                     â”‚            â”‚
â”‚  â”‚   "ids_creados": ["uuid1", "uuid2", ...]            â”‚            â”‚
â”‚  â”‚ }                                                    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 7: PROCESAMIENTO DE RESULTADO**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š PASO 7: Procesar Resultado del Batch                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  POBLAR MODELO:                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ resultado = ActualizacionOdontogramaResult()       â”‚        â”‚
â”‚  â”‚ resultado.exitosos = batch_result["exitosos"]      â”‚        â”‚
â”‚  â”‚ resultado.fallidos = batch_result["fallidos"]      â”‚        â”‚
â”‚  â”‚ resultado.ids_creados = batch_result["ids_creados"]â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  VERIFICAR FALLOS:                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ Si resultado.fallidos > 0:                         â”‚        â”‚
â”‚  â”‚   resultado.advertencias.append(                   â”‚        â”‚
â”‚  â”‚     f"{fallidos} actualizaciones fallaron"         â”‚        â”‚
â”‚  â”‚   )                                                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  LOGGING:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ logger.info(                                       â”‚        â”‚
â”‚  â”‚   f"âœ… Odontograma actualizado | "                â”‚        â”‚
â”‚  â”‚   f"Exitosos: {exitosos} | "                      â”‚        â”‚
â”‚  â”‚   f"Fallidos: {fallidos} | "                      â”‚        â”‚
â”‚  â”‚   f"Tasa Ã©xito: {tasa_exito:.1f}%"                â”‚        â”‚
â”‚  â”‚ )                                                   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  Â¿exitosos > 0?                                                  â”‚
â”‚    â†“ SÃ â†’ Continuar a Paso 8 (Recargar UI)                      â”‚
â”‚    â†“ NO â†’ Return resultado                                      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **PASO 8: RECARGA DE UI**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â™»ï¸ PASO 8: Recargar Odontograma en UI                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  VERIFICAR DISPONIBILIDAD:                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ if hasattr(self, "cargar_odontograma_paciente"):   â”‚        â”‚
â”‚  â”‚   â† MÃ©todo existe en contexto?                     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  RECARGAR:                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ try:                                               â”‚        â”‚
â”‚  â”‚   await self.cargar_odontograma_paciente(          â”‚        â”‚
â”‚  â”‚     self.paciente_actual.id                        â”‚        â”‚
â”‚  â”‚   )                                                 â”‚        â”‚
â”‚  â”‚   logger.info("â™»ï¸ Odontograma recargado")         â”‚        â”‚
â”‚  â”‚                                                     â”‚        â”‚
â”‚  â”‚ except Exception as e:                             â”‚        â”‚
â”‚  â”‚   logger.warning(                                  â”‚        â”‚
â”‚  â”‚     f"âš ï¸ No se pudo recargar: {e}"                â”‚        â”‚
â”‚  â”‚   )                                                 â”‚        â”‚
â”‚  â”‚   resultado.advertencias.append(                   â”‚        â”‚
â”‚  â”‚     "No se pudo recargar UI"                       â”‚        â”‚
â”‚  â”‚   )                                                 â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  QUERY EJECUTADA:                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ SELECT diente_numero, superficie, tipo_condicion,  â”‚        â”‚
â”‚  â”‚        color_hex, fecha_registro, material         â”‚        â”‚
â”‚  â”‚ FROM condiciones_diente                            â”‚        â”‚
â”‚  â”‚ WHERE paciente_id = ?                              â”‚        â”‚
â”‚  â”‚   AND activo = TRUE  â† Solo condiciones actuales   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                                  â”‚
â”‚  âœ… RESULTADO: UI muestra odontograma actualizado                â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ TRANSFORMACIÃ“N DE DATOS (Ejemplo Completo)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EJEMPLO: Un Servicio con MÃºltiples Superficies                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT (Servicio Original):
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ServicioIntervencionCompleto(
  nombre_servicio="ObturaciÃ³n MOD",
  nueva_condicion="obturacion",
  diente_numero=11,
  superficies=["mesial", "oclusal", "distal"],  â† 3 superficies
  material="Resina Compuesta Z350",
  observaciones="TÃ©cnica incremental"
)

â†“ PASO 2: NormalizaciÃ³n
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
{
  "nombre": "ObturaciÃ³n MOD",
  "condicion_resultante": "obturacion",
  "diente_numero": 11,
  "superficies": ["mesial", "oclusal", "distal"],
  "material": "Resina Compuesta Z350",
  "observaciones": "TÃ©cnica incremental"
}

â†“ PASO 3: Filtrado
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… INCLUIDO (tiene condicion_resultante + diente_numero)

â†“ PASO 4: ResoluciÃ³n Conflictos
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(Asumiendo no hay conflictos)
Servicio pasa sin cambios

â†“ PASO 5: ExplosiÃ³n Batch
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
actualizaciones = [
  {
    "paciente_id": "uuid-pac-123",
    "diente_numero": 11,
    "superficie": "mesial",      â† REGISTRO 1
    "tipo_condicion": "obturacion",
    "material_utilizado": "Resina Compuesta Z350",
    "descripcion": "TÃ©cnica incremental",
    "intervencion_id": "uuid-interv-456"
  },
  {
    "paciente_id": "uuid-pac-123",
    "diente_numero": 11,
    "superficie": "oclusal",     â† REGISTRO 2
    "tipo_condicion": "obturacion",
    "material_utilizado": "Resina Compuesta Z350",
    "descripcion": "TÃ©cnica incremental",
    "intervencion_id": "uuid-interv-456"
  },
  {
    "paciente_id": "uuid-pac-123",
    "diente_numero": 11,
    "superficie": "distal",      â† REGISTRO 3
    "tipo_condicion": "obturacion",
    "material_utilizado": "Resina Compuesta Z350",
    "descripcion": "TÃ©cnica incremental",
    "intervencion_id": "uuid-interv-456"
  }
]

â†“ PASO 6: EjecuciÃ³n SQL
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Para cada actualizaciÃ³n:

  1. UPDATE condiciones_diente
     SET activo = FALSE
     WHERE paciente_id = 'uuid-pac-123'
       AND diente_numero = 11
       AND superficie = 'mesial'  â† (luego oclusal, distal)
       AND activo = TRUE

  2. INSERT INTO condiciones_diente (...)
     VALUES (uuid-pac-123, 11, 'mesial', 'obturacion', ...)
     RETURNING id

â†“ RESULTADO FINAL EN BD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ diente   â”‚ superf  â”‚ condicion â”‚ material â”‚ activo â”‚ intervencion_id â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 11       â”‚ mesial  â”‚ sano      â”‚ -        â”‚ FALSE  â”‚ NULL            â”‚â† HISTÃ“RICO
â”‚ 11       â”‚ mesial  â”‚ obturacionâ”‚ Resina.. â”‚ TRUE   â”‚ uuid-interv-456 â”‚â† NUEVO
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 11       â”‚ oclusal â”‚ caries    â”‚ -        â”‚ FALSE  â”‚ uuid-old        â”‚â† HISTÃ“RICO
â”‚ 11       â”‚ oclusal â”‚ obturacionâ”‚ Resina.. â”‚ TRUE   â”‚ uuid-interv-456 â”‚â† NUEVO
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 11       â”‚ distal  â”‚ sano      â”‚ -        â”‚ FALSE  â”‚ NULL            â”‚â† HISTÃ“RICO
â”‚ 11       â”‚ distal  â”‚ obturacionâ”‚ Resina.. â”‚ TRUE   â”‚ uuid-interv-456 â”‚â† NUEVO
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… RESULTADO: 3 superficies actualizadas, historial mantenido
```

---

## âš ï¸ ESCENARIOS DE ERROR

### **Error 1: Servicio con MÃºltiples Dientes**

```
âŒ PROBLEMA DETECTADO

INPUT:
â”€â”€â”€â”€â”€â”€
ServicioIntervencionCompleto(
  dientes_afectados="11, 12, 13",  â† 3 DIENTES
  condicion_resultante="obturacion",
  ...
)

â†“ NORMALIZACIÃ“N (PASO 2)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dientes = _extraer_numeros_dientes("11, 12, 13")
# â†’ [11, 12, 13]

diente_numero = dientes[0]  â† âš ï¸ SOLO TOMA PRIMERO
# â†’ 11

RESULTADO: Solo se actualiza diente 11
           Dientes 12 y 13 SE PIERDEN

SOLUCIÃ“N PROPUESTA:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Retornar LISTA de servicios (uno por diente)
- O explosionar en PASO 5 en vez de PASO 2
```

### **Error 2: Conflicto de Prioridad**

```
âŒ LÃ“GICA AMBIGUA

ESCENARIO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. Servicio A: "DiagnÃ³stico Caries" â†’ diente 11
   - CondiciÃ³n: "caries" (prioridad 90)

2. Servicio B: "ObturaciÃ³n" â†’ diente 11
   - CondiciÃ³n: "obturacion" (prioridad 70)

â†“ RESOLUCIÃ“N (PASO 4)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ordenar por prioridad DESC:
  [caries(90), obturacion(70)]

Ganador: caries

PROBLEMA:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Si se aplicÃ³ obturaciÃ³n, el diente YA NO TIENE caries
La obturaciÃ³n TRATA la caries

Pero el sistema deja "caries" como condiciÃ³n final

SOLUCIÃ“N:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Usar orden temporal (Ãºltimo servicio aplicado gana)
O usar lÃ³gica mÃ©dica explÃ­cita (tratamiento > diagnÃ³stico)
```

### **Error 3: Fallo Parcial en Batch**

```
âŒ SIN TRANSACCIÃ“N EXPLÃCITA

ESCENARIO:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Batch con 10 actualizaciones:
  1-4: âœ… Exitosas
  5:   âŒ Error (constraint violation)
  6-10: â“ Â¿Se ejecutan?

COMPORTAMIENTO ACTUAL:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- Actualizaciones 1-4 PERSISTEN (no se revierten)
- ActualizaciÃ³n 5 falla
- Actualizaciones 6-10 probablemente continÃºan

RESULTADO: Base de datos en estado inconsistente

SOLUCIÃ“N:
â”€â”€â”€â”€â”€â”€â”€â”€â”€
Agregar transacciÃ³n explÃ­cita en SQL:

BEGIN;
  -- Todas las actualizaciones
COMMIT;

EXCEPTION WHEN OTHERS THEN
  ROLLBACK;
```

---

## ğŸ¯ MÃ‰TRICAS DE PERFORMANCE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ANÃLISIS DE QUERIES Y TIEMPOS                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

QUERIES EJECUTADAS:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1. SELECT * FROM catalogo_condiciones WHERE activo = TRUE
   Tiempo: ~10ms
   Frecuencia: 1 vez por invocaciÃ³n

2. RPC actualizar_condiciones_batch(jsonb)
   Tiempo: ~50ms (para 10 actualizaciones)
   Frecuencia: 1 vez por invocaciÃ³n
   Internamente: N Ã— (UPDATE + INSERT)

3. SELECT * FROM condiciones_diente WHERE paciente_id = ? AND activo = TRUE
   Tiempo: ~15ms
   Frecuencia: 1 vez (solo si exitosos > 0)

TOTAL TIEMPO ESTIMADO: ~75ms (Ã³ptimo)
TOTAL QUERIES: 3 (excelente)

COMPARACIÃ“N CON ALTERNATIVA NAIVE:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âŒ Alternativa: Una query por superficie
   - 10 superficies â†’ 10 Ã— (UPDATE + INSERT) = 20 queries
   - Tiempo total: ~200ms

âœ… Actual: Batch Ãºnico
   - 1 RPC con N actualizaciones
   - Tiempo total: ~75ms
   - Mejora: 62% mÃ¡s rÃ¡pido
```

---

## ğŸ“ RESUMEN DE PROBLEMAS DETECTADOS

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROBLEMAS CRÃTICOS (Requieren correcciÃ³n)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. âŒ LÃ³gica de prioridad ambigua (severidad vs temporalidad)     â”‚
â”‚ 2. âŒ Servicios con mÃºltiples dientes pierden datos               â”‚
â”‚ 3. âš ï¸ Batch sin transacciÃ³n explÃ­cita (inconsistencia posible)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MEJORAS RECOMENDADAS (OptimizaciÃ³n)                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. âš™ï¸ Eliminar normalizaciÃ³n multi-formato                        â”‚
â”‚ 2. âš™ï¸ Mover resoluciÃ³n conflictos a SQL                           â”‚
â”‚ 3. âš™ï¸ Extraer subfunciones (80 lÃ­neas â†’ 25 lÃ­neas)                â”‚
â”‚ 4. âš™ï¸ Agregar validaciÃ³n de superficies                           â”‚
â”‚ 5. âš™ï¸ Implementar optimistic locking                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**FIN DEL DIAGRAMA**

**Archivos Relacionados:**
- `ANALISIS_EXHAUSTIVO_ACTUALIZAR_ODONTOGRAMA.md` (anÃ¡lisis tÃ©cnico completo)
- `estado_intervencion_servicios.py` (cÃ³digo fuente)
- `odontologia_service.py` (servicio de BD)

**Fecha:** 2025-10-19
**Autor:** Claude Code
